{% extends 'layouts/base.html' %}
{% load static %}

{% block page_title %}Evaluación de Desempeño Cualitativa{% endblock %}

{% block content %}

<style>
    /* Estilos para igualar el look del Excel */
    .thead-dark-blue {
        background-color: #1f4e79;
        color: white;
    }
    .bg-light-blue {
        background-color: #dfe7f5;
    }
    .table-input {
        width: 100%;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 4px;
    }
    textarea.table-input {
        resize: vertical;
        min-height: 60px;
    }
    .score-cell {
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        background-color: #eef;
    }
    .logro-cell {
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        font-size: 1.1rem;
    }
    .desc-cell {
        font-size: 0.85rem;
        min-width: 280px; /* Un poco más ancho para que lea bien el texto largo */
        text-align: justify;
    }
    .sticky-total {
        position: sticky;
        bottom: 0;
        background-color: #1f4e79;
        color: white;
        font-size: 1.1rem;
        z-index: 10;
    }
    .text-white-force {
        color: white !important;
    }
    /* Fondos específicos para Logro imitando el Excel */
    .bg-excelente { background-color: #d9ead3 !important; color: #38761d; } /* Verde suave */
    .bg-bueno { background-color: #cfe2f3 !important; color: #0b5394; }     /* Azul suave */
    .bg-regular { background-color: #fff2cc !important; color: #bf9000; }   /* Amarillo suave */
</style>

<div class="container-fluid py-4">

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom-0">
        </div>
        <div class="card-body pt-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0">
                    <tbody>
                        <tr>
                            <td class="bg-light fw-bold" style="width: 15%;">Nombre del colaborador:</td>
                            <td style="width: 35%;">{{ employee.user.get_full_name|upper }}</td>
                            <td class="bg-light fw-bold" style="width: 15%;">No. de Empleado:</td>
                            <td style="width: 35%;">{{ employee.employee_number }}</td>
                        </tr>
                        <tr>
                            <td class="bg-light fw-bold">Puesto:</td>
                            <td>{{ review.employee.job_position.title|default:review.employee.job_position }}</td>
                            <td class="bg-light fw-bold">Periodo Evaluado:</td>
                            <td class="text-primary fw-bold">{{ periodo_texto }}</td>
                        </tr>
                        <tr>
                            <td class="bg-light fw-bold">Área:</td>
                            <td>{{ employee.department.name|default:"General" }}</td>
                            <td class="bg-light fw-bold">Periodo de Revisión:</td>
                            <td>{{ review.cycle.name }}</td>

                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <form method="POST" id="evalForm">
        {% csrf_token %}
        
        <div class="card shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0 align-middle">
                        <thead class="thead-dark-blue text-center small align-middle">
                            <tr>
                                <th rowspan="2" style="width: 8%;" class="text-white-force">Competencias</th>
                                <th rowspan="2" style="width: 25%;" class="text-white-force">Descripción</th>
                                <th rowspan="2" style="width: 5%;" class="text-white-force">Valor (%)</th>
                                <th rowspan="2" style="width: 5%;" class="text-white-force">Objetivo</th>
                                <th colspan="3" class="text-white-force">Metas 2024</th> 
                                <th rowspan="2" style="width: 4%; background-color: #1155cc;" class="text-white-force">Logro</th>
                                <th rowspan="2" style="width: 5%;" class="text-white-force">Puntos %</th> 
                                <th rowspan="2" style="width: 15%;" class="text-white-force">Comentarios Líder</th>
                                <th rowspan="2" style="width: 15%;" class="text-white-force">Compromisos</th>
                            </tr>
                            <tr>
                                <th class="bg-secondary text-white-force" style="font-size: 0.75rem;">Regular (1)</th>
                                <th class="bg-info text-white-force" style="font-size: 0.75rem;">Satisfactorio (2)</th>
                                <th class="bg-success text-white-force" style="font-size: 0.75rem;">Excelente (3)</th>
                            </tr>
                        </thead>
                            <tbody>
                                
                                <tr class="fila-evaluacion" id="row_comunicacion">
                                    <td class="fw-bold text-center small">COMUNICACIÓN</td>
                                    <td class="desc-cell text-muted">Comparte información de manera clara y asertiva...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="15"> 15%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('comunicacion', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('comunicacion', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('comunicacion', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_comunicacion" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_comunicacion"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_comunicacion"></textarea></td>
                                </tr>

                                <tr class="fila-evaluacion" id="row_equipo">
                                    <td class="fw-bold text-center small">TRABAJO EN EQUIPO</td>
                                    <td class="desc-cell text-muted">Participa activamente, colabora y coopera...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="15"> 15%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('equipo', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('equipo', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('equipo', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_equipo" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_equipo"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_equipo"></textarea></td>
                                </tr>

                                <tr class="fila-evaluacion" id="row_conflicto">
                                    <td class="fw-bold text-center small">RESOLUCIÓN DE CONFLICTO</td>
                                    <td class="desc-cell text-muted">Analiza situaciones con objetividad...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="15"> 15%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('conflicto', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('conflicto', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('conflicto', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_conflicto" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_conflicto"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_conflicto"></textarea></td>
                                </tr>

                                <tr class="fila-evaluacion" id="row_tiempo">
                                    <td class="fw-bold text-center small">GESTIÓN DEL TIEMPO</td>
                                    <td class="desc-cell text-muted">Organiza y prioriza sus actividades...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="15"> 15%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('tiempo', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('tiempo', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('tiempo', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_tiempo" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_tiempo"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_tiempo"></textarea></td>
                                </tr>

                                <tr class="fila-evaluacion" id="row_servicio">
                                    <td class="fw-bold text-center small">SERVICIO AL CLIENTE</td>
                                    <td class="desc-cell text-muted">Brinda un servicio de calidad...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="15"> 15%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('servicio', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('servicio', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('servicio', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_servicio" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_servicio"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_servicio"></textarea></td>
                                </tr>

                                <tr class="fila-evaluacion" id="row_iniciativa">
                                    <td class="fw-bold text-center small">INICIATIVA</td>
                                    <td class="desc-cell text-muted">Propone ideas y soluciones...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="15"> 15%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('iniciativa', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('iniciativa', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('iniciativa', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_iniciativa" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_iniciativa"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_iniciativa"></textarea></td>
                                </tr>

                                <tr class="fila-evaluacion" id="row_asistencia">
                                    <td class="fw-bold text-center small">ASISTENCIA</td>
                                    <td class="desc-cell text-muted">Obtuvo una asistencia mayor al 98%...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="7"> 7%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('asistencia', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('asistencia', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('asistencia', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_asistencia" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_asistencia"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_asistencia"></textarea></td>
                                </tr>

                                <tr class="fila-evaluacion" id="row_puntualidad">
                                    <td class="fw-bold text-center small">PUNTUALIDAD</td>
                                    <td class="desc-cell text-muted">Cumple con los horarios establecidos...</td>
                                    <td class="text-center"><input type="hidden" class="valor-weight" value="3"> 3%</td>
                                    <td class="text-center fw-bold text-primary">BUENO</td>
                                    
                                    <td class="text-center clickable-cell cell-1" onclick="selectRating('puntualidad', 1)">REGULAR</td>
                                    <td class="text-center clickable-cell cell-2" onclick="selectRating('puntualidad', 2)">BUENO</td>
                                    <td class="text-center clickable-cell cell-3" onclick="selectRating('puntualidad', 3)">EXCELENTE</td>
                                    
                                    <td class="logro-cell">0</td>
                                    <input type="hidden" name="logro_puntualidad" class="logro-input" value="0">
                                    <td class="score-cell text-end"><span class="puntos-reales">0.00</span>%</td>
                                    
                                    <td><textarea class="form-control form-control-sm" name="com_puntualidad"></textarea></td>
                                    <td><textarea class="form-control form-control-sm" name="comp_puntualidad"></textarea></td>
                                </tr>

                            </tbody>
                            
                            <tfoot class="sticky-total">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold text-white-force">TOTALES:</td>
                                    <td class="text-center fw-bold text-white-force">100%</td>
                                    <td colspan="4"></td>
                                    <td class="text-end fw-bold bg-warning text-dark border border-dark">
                                        <span id="granTotal">0.00</span>%
                                    </td>
                                    <td colspan="2" class="bg-white"></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <tfoot class="sticky-total">
                            <tr>
                                <td colspan="4" class="text-end fw-bold text-white-force">TOTALES:</td>
                                <td class="text-center fw-bold text-white-force">100%</td>
                                <td colspan="5"></td>
                                <td class="text-end fw-bold bg-warning text-dark border border-dark">
                                    <span id="granTotal">0.00</span>%
                                </td>
                                <td colspan="2" class="bg-white"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light text-end">
                <button type="button" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-primary fw-bold">
                    <i class="fas fa-save me-2"></i>Guardar Evaluación
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    function selectRating(rowKey, value) {
        // 1. Identificar la fila
        const row = document.getElementById('row_' + rowKey);
        
        // 2. Limpiar selección previa
        row.querySelectorAll('.clickable-cell').forEach(cell => {
            cell.classList.remove('selected-cell', 'bg-regular-select', 'bg-bueno-select', 'bg-excelente-select');
        });

        // 3. Pintar la celda seleccionada y poner el valor en Logro
        const selectedCell = row.querySelector('.cell-' + value);
        const celdaLogro = row.querySelector('.logro-cell');
        const inputLogro = row.querySelector('.logro-input');
        
        selectedCell.classList.add('selected-cell');
        
        // Colores y Factores Matemáticos
        let factor = 0;
        
        // REGULAR (1) -> 80% del valor (Factor 0.8)
        if (value === 1) { 
            selectedCell.classList.add('bg-regular-select');
            celdaLogro.classList.add('bg-regular-select');
            celdaLogro.classList.remove('bg-bueno-select', 'bg-excelente-select');
            factor = 0.8; 
        } 
        // BUENO (2) -> 100% del valor (Factor 1.0)
        else if (value === 2) { 
            selectedCell.classList.add('bg-bueno-select');
            celdaLogro.classList.add('bg-bueno-select');
            celdaLogro.classList.remove('bg-regular-select', 'bg-excelente-select');
            factor = 1.0; 
        } 
        // EXCELENTE (3) -> 110% del valor (Factor 1.1)
        else if (value === 3) { 
            selectedCell.classList.add('bg-excelente-select');
            celdaLogro.classList.add('bg-excelente-select');
            celdaLogro.classList.remove('bg-regular-select', 'bg-bueno-select');
            factor = 1.1; 
        }

        // 4. Actualizar columna "Logro" (1, 2, 3)
        celdaLogro.innerText = value;
        inputLogro.value = value;

        // 5. Calcular Puntos % (Peso * Factor)
        const peso = parseFloat(row.querySelector('.valor-weight').value);
        const puntos = peso * factor;
        
        row.querySelector('.puntos-reales').innerText = puntos.toFixed(2);

        // 6. Recalcular Gran Total
        calcularTotalGeneral();
    }

    function calcularTotalGeneral() {
        let total = 0;
        document.querySelectorAll('.puntos-reales').forEach(span => {
            total += parseFloat(span.innerText);
        });
        
        document.getElementById('granTotal').innerText = total.toFixed(2);
        document.getElementById('grand_total_input').value = total.toFixed(2);
    }
</script>

{% endblock %}
{% extends 'layouts/base.html' %}
{% load static %}
{% block page_title %}Noticias{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/news.css' %}">
{% endblock %}

{% block content %}
<h1>Noticias</h1>

  <form class="mb-3" method="get">
    <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="🔍 Buscar por título de noticia">
  </form>

<!-- Grid de noticias -->
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="news-grid">
  {% for n in news %}
  <div class="col news-card" data-tags="{% for t in n.tags.all %}tag-{{ t.id }} {% endfor %}">
    <div class="card card-smooth h-100">
    <div class="cover-wrapper position-relative">
        {% if n.cover_image %}
        <img src="{{ n.cover_image.url }}" alt="Portada de {{ n.title }}" class="news-cover">
        {% else %}
        <img src="{% static 'img/placeholder-16x9.jpg' %}" alt="Sin portada" class="news-cover">
        {% endif %}
        <a href="{% url 'news_detail_user' n.id %}"
        class="stretched-link"
        aria-label="Abrir detalle de {{ n.title }}"></a>
    </div>
    {# ⬆️ SOLO LA PORTADA ES CLICABLE AL DETALLE ⬆️ #}

      <div class="card-body">
        <h5 class="card-title line-clamp-2 mb-2">{{ n.title }}</h5>
        <hr class="my-4">

        <div class="text-muted mb-3" style="font-size:.9rem;">
          🕒 Hace {{ n.published_at|timesince }}
        </div>

        <div class="d-flex align-items-center gap-3">
          <button type="button"
                  class="btn btn-sm rounded-3 btn-like {% if n.my_liked %}btn-success {% else %}btn-outline-secondary{% endif %}"
                  data-url="{% url 'news_like_toggle' n.id %}"
                  aria-pressed="{{ n.my_liked|yesno:'true,false' }}">
            👍 <span class="like-count">{{ n.like_count }}</span>
          </button>

          <span title="Comentarios">💬 <span class="comment-count">{{ n.comment_count }}</span></span>
            <a class="btn btn-sm btn-outline-primary btn-view-likes"
              data-url="{% url 'news_likes_list' n.id %}"
              data-bs-toggle="offcanvas"
              data-bs-target="#likesOffcanvas">
              Ver likes
            </a>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col">
    <div class="alert alert-light border">No hay noticias visibles aún.</div>
  </div>
  {% endfor %}
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="likesOffcanvas" aria-labelledby="likesOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 id="likesOffcanvasLabel">A quién le gusta esta noticia</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body">
    <div id="likes-loader" class="text-center d-none">
      <div class="spinner-border" role="status"></div>
      <div class="mt-2">Cargando...</div>
    </div>
    <div id="likes-empty" class="alert alert-light border d-none">Aún no hay likes en esta noticia.</div>
    <ul id="likes-list" class="list-group list-group-flush d-none"></ul>
  </div>
  <div class="offcanvas-footer p-3 border-top">
    <small class="text-muted"><span id="likes-count">0</span> personas han dado like</small>
  </div>
</div>


{% endblock %}

{% block scripts %}
  <script src="{% static 'js/news.js' %}"></script>
{% endblock %}

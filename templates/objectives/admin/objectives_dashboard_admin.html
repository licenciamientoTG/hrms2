{% extends 'layouts/base.html' %}
{% load static %}

{% block page_title %}Objetivos · Admin{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Objetivos</h2>
  <a href="{% url 'obj_cycle_create' %}" class="btn btn-primary">Nuevo ciclo</a>
</div>

<div class="card p-3">
  <form id="cycleSearch" class="mb-3" method="get" action="{% url 'admin_objective' %}">
    <input type="search" name="q" value="{{ q }}" class="form-control" placeholder="🔍 Buscar por nombre">
    <!-- botón oculto para que Enter siempre envíe, algunos navegadores lo requieren -->
    <button type="submit" class="d-none" aria-hidden="true">Buscar</button>
  </form>


  <table class="table table-hover align-middle" id="admin-objectives-cycles-table">
    <thead>
      <tr>
        <th>Ciclo</th>
        <th>Iniciar</th>
        <th>Fin</th>
        <th>Objetivos</th>
        <th class="text-end">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for c in cycles %}
        <tr data-cycle-id="{{ c.id }}">
          <td class="fw-medium">{{ c.name }}</td>
          <td>{{ c.start_date|date:"d/M/Y"|upper }}</td>
          <td>{{ c.end_date|date:"d/M/Y"|upper }}</td>
          <td>{{ c.objectives_count|default:0 }}</td>
          <td class="text-end">
            <div class="dropdown">
              <a class="btn btn-link dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">⋮</a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Editar</a></li>
                <li><a class="dropdown-item" href="#">Participación</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="post"
                        action="{% url 'cycle_delete' c.id %}"
                        class="delete-cycle-form">
                    {% csrf_token %}
                    <input type="hidden" name="ajax" value="1">  {# 1=AJAX, 0=post normal #}
                    <button type="button"
                            class="dropdown-item text-danger w-100 text-start js-delete-cycle"
                            data-title="{{ c.name|escape }}">
                      Eliminar
                    </button>
                  </form>
                </li>
              </ul>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="5" class="text-center py-4">No hay ciclos aún.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if page_obj %}
    <div class="d-flex justify-content-between align-items-center">
      <div>Filas por página: {{ page_obj.paginator.per_page }}</div>
      <div>
        {% if page_obj.has_previous %}
          <a class="btn btn-sm btn-outline-secondary" href="?q={{ q }}&page={{ page_obj.previous_page_number }}">‹</a>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>‹</button>
        {% endif %}
        <span class="mx-2">{{ page_obj.start_index }}–{{ page_obj.end_index }} de {{ page_obj.paginator.count }}</span>
        {% if page_obj.has_next %}
          <a class="btn btn-sm btn-outline-secondary" href="?q={{ q }}&page={{ page_obj.next_page_number }}">›</a>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>›</button>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}

{% block scripts %}
  <script src="{% static 'js/objectives_admin.js' %}"></script>
<script>
// confirmación + delete (AJAX si input[name="ajax"] == 1)
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.js-delete-cycle');
  if (!btn) return;

  const form = btn.closest('form.delete-cycle-form');
  const row  = btn.closest('tr');
  const name = btn.dataset.title || 'este ciclo';

  if (!confirm(`¿Eliminar "${name}"? Esta acción no se puede deshacer.`)) return;

  const useAjax = form.querySelector('input[name="ajax"]')?.value === '1';
  if (!useAjax) { form.submit(); return; }

  const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

  fetch(form.action, {
    method: 'POST',
    credentials: 'same-origin',                      // 👈 asegura que viajen cookies/sesión
    headers: {
      'X-CSRFToken': csrf,
      'X-Requested-With': 'XMLHttpRequest',
      'Accept': 'application/json',
      'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
    },
    body: new URLSearchParams(new FormData(form))
  })
  .then(async (r) => {
    // Si hubo redirección (p.ej. a login) o status != 200 => error legible
    if (!r.ok) {
      const text = await r.text();
      throw new Error(`HTTP ${r.status} ${r.statusText} - ${text.slice(0,120)}…`);
    }
    // intenta parsear JSON; si falla, también error
    const data = await r.json().catch(() => { throw new Error('Respuesta no es JSON'); });
    if (!data.ok) throw new Error(data.error || 'No se pudo eliminar');
    // OK
    row.remove();
  })
  .catch((err) => {
    // Si te manda al login/403/CSRF verás esto:
    console.error('Delete error:', err);
    alert('Error al eliminar. Revisa permisos y CSRF (ver consola).');
  });
});
</script>


{% endblock %}

{% extends 'layouts/base.html' %}
{% load static %}

{% block page_title %}Solicitudes de vacaciones{% endblock %}

{% block styles %}
  {# Reutilizamos el mismo CSS que usas en constancias para que se vea idéntico #}
  <link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>Solicitudes de vacaciones</h1>
  {% comment %} asdadadada {% endcomment %}

  {% comment %} Buscador (opcional, mismo estilo que constancias) {% endcomment %}
  <input type="text" id="vacSearch" class="form-control search-bar" placeholder="Buscar formulario...">
  <div class="alert alert-info">
    Días de vacaciones disponibles: {{  saldo_total|floatformat:"-2" }}
  </div>



  {% comment %} Tabs {% endcomment %}
  <div class="tab-container mb-3">
    <div class="tab active" id="tab-disponibles">Disponibles</div>
    <div class="tab" id="tab-proceso">En proceso</div>
    <div class="tab" id="tab-completados">Completados</div>
  </div>

  {% comment %} DISPONIBLES {% endcomment %}
  <div id="contenedor-disponibles">
    <div class="form-list" id="list-disponibles">
      <!-- Vacaciones -->
      <div class="form-item mb-3">
        <i class="form-icon bi bi-sun-fill"></i>
        <div class="form-name">
          Vacaciones
          <p class="muted-70">Solicita días de descanso por vacaciones.</p>
        </div>
        <div class="form-actions">
          <a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalVacacion">Solicitar</a>
        </div>
      </div>

      {% comment %} Días de estudio
      <div class="form-item mb-3">
        <i class="form-icon bi bi-mortarboard-fill"></i>
        <div class="form-name">
          Días de estudio
          <p class="muted-70">Pide permiso por motivos académicos.</p>
        </div>
        <div class="form-actions">
          <a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEstudio">Solicitar</a>
        </div>
      </div>

      <!-- Descanso médico -->
      <div class="form-item mb-3">
        <i class="form-icon bi bi-clipboard2-pulse-fill"></i>
        <div class="form-name">
          Descanso médico
          <p class="muted-70">Sube tu justificante y registra tu ausencia.</p>
        </div>
        <div class="form-actions">
          <a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalMedico">Solicitar</a>
        </div>
      </div>

      <!-- Maternidad -->
      <div class="form-item mb-3">
        <i class="form-icon bi bi-emoji-smile-upside-down"></i>
        <div class="form-name">
          Maternidad
          <p class="muted-70">Inicio y fin del período por maternidad.</p>
        </div>
        <div class="form-actions">
          <a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalMaternidad">Solicitar</a>
        </div>
      </div> {% endcomment %}
    </div>
  </div>

  <!-- ========= EN PROCESO ========= -->
  <div id="contenedor-proceso" style="display:none;">
    {% if pending_requests %}
      {% for r in pending_requests %}
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              {{ r.tipo_solicitud|title }} ·
              <small class="text-muted">
                {{ r.start_date|date:"d/m/Y" }} — {{ r.end_date|date:"d/m/Y" }}
              </small>
            </h5>
            <span class="badge bg-warning text-dark">Pendiente</span>
          </div>

          <div class="row mt-3 text-start">
            <div class="col-md-6">
              <p class="mb-1"><strong>Días:</strong> {{ r.total_days|default:"—" }}</p>
              <p class="mb-1"><strong>Creado:</strong> {{ r.created_at|date:"d/m/Y H:i" }}</p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><strong>Comentario:</strong></p>
              <p class="mb-0 text-muted">{{ r.reason|default:"—" }}</p>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="form-list">
        <div class="form-item mb-3">
          <i class="form-icon bi bi-inbox"></i>
          <div class="form-name">No tienes solicitudes en proceso.</div>
        </div>
      </div>
    {% endif %}
  </div>
  <!-- ========= COMPLETADOS ========= -->
  <div id="contenedor-completados" style="display:none;">
    {% if finished_requests %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-start">Tipo</th>
              <th class="text-start">Rango</th>
              <th class="text-center">Días</th>
              <th class="text-start">Estado</th>
              <th class="text-center">Comprobante</th>
            </tr>
          </thead>
          <tbody>
            {% for r in finished_requests %}
            <tr>
              <!-- Tipo -->
              <td class="text-start">
                {{ r.tipo_solicitud }}
              </td>

              <!-- Rango de fechas -->
              <td class="text-start text-nowrap">
                {{ r.start_date|date:"d/m/Y" }} — {{ r.end_date|date:"d/m/Y" }}
              </td>

              <!-- Días -->
              <td class="text-center">
                {{ r.total_days|default:"—" }}
              </td>

              <!-- Estado -->
              <td class="text-start">
                {% with st=r.status %}
                  <span class="badge
                    {% if st == 'approved' %} bg-success
                    {% elif st == 'rejected' %} bg-danger
                    {% elif st == 'pending' %} bg-warning text-dark
                    {% else %} bg-secondary {% endif %}">
                    {% if st == 'approved' %}
                      Aprobada
                    {% elif st == 'rejected' %}
                      Rechazada
                    {% elif st == 'pending' %}
                      Pendiente
                    {% else %}
                      {{ st }}
                    {% endif %}
                  </span>
                {% endwith %}
              </td>

              <!-- Comprobante -->
              <td class="text-center">
                {% if r.documento %}
                  <a class="btn btn-link btn-sm p-0" href="{{ r.documento.url }}" target="_blank" rel="noopener">
                    Ver
                  </a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="form-list">
        <div class="form-item mb-3">
          <i class="form-icon bi bi-check2-circle"></i>
          <div class="form-name">No tienes solicitudes completadas.</div>
        </div>
      </div>
    {% endif %}
  </div>

</div>

<!-- Modal Vacaciones -->
<div class="modal fade" id="modalVacacion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'vacation_form_user' %}" enctype="multipart/form-data" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="tipo_solicitud" value="Vacaciones">
      <div class="modal-header">
        <h5 class="modal-title">Solicitar vacaciones</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div>
          Días disponibles: {{ saldo_total|floatformat:"-2" }}
        </div>
        <br>
        <div class="row g-2">
          {% now "Y-m-d" as hoy %}

          <div class="col-6">
            <label class="form-label">Fecha inicio</label>
            <input
              type="date"
              class="form-control"
              name="fecha_inicio"
              required
              min="{{ hoy }}"
            >
          </div>
          <div class="col-6">
            <label class="form-label">Fecha fin</label>
            <input type="date" class="form-control" name="fecha_fin" required min="{{ hoy}}">
          </div>
          <div class="col-12">
            <label class="form-label">Motivo/observaciones</label>
            <textarea class="form-control" name="observaciones" rows="3" placeholder="Opcional…"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Documento (PDF, opcional)</label>
            <input type="file" class="form-control" name="documento" accept="application/pdf">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Enviar solicitud</button>
      </div>
    </form>
  </div>
</div>

<!-- Reutilizamos el mismo modal para otros tipos cambiando el hidden -->
<div class="modal fade" id="modalEstudio" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'vacation_form_user' %}" enctype="multipart/form-data" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="tipo_solicitud" value="Días de estudio">
      <div class="modal-header">
        <h5 class="modal-title">Solicitar días de estudio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">Fecha inicio</label><input type="date" class="form-control" name="fecha_inicio" required></div>
          <div class="col-6"><label class="form-label">Fecha fin</label><input type="date" class="form-control" name="fecha_fin" required></div>
          <div class="col-12"><label class="form-label">Motivo / Observaciones</label><textarea class="form-control" name="observaciones" rows="3"></textarea></div>
          <div class="col-12"><label class="form-label">Documento (PDF, opcional)</label><input type="file" class="form-control" name="documento" accept="application/pdf"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Enviar solicitud</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="modalMedico" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'vacation_form_user' %}" enctype="multipart/form-data" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="tipo_solicitud" value="Descanso médico">
      <div class="modal-header">
        <h5 class="modal-title">Solicitar descanso médico</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">Fecha inicio</label><input type="date" class="form-control" name="fecha_inicio" required></div>
          <div class="col-6"><label class="form-label">Fecha fin</label><input type="date" class="form-control" name="fecha_fin" required></div>
          <div class="col-12"><label class="form-label">Observaciones</label><textarea class="form-control" name="observaciones" rows="3"></textarea></div>
          <div class="col-12"><label class="form-label">Justificante (PDF)</label><input type="file" class="form-control" name="documento" accept="application/pdf"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Enviar solicitud</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="modalMaternidad" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'vacation_form_user' %}" enctype="multipart/form-data" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="tipo_solicitud" value="Licencia por maternidad">
      <div class="modal-header">
        <h5 class="modal-title">Solicitar maternidad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">Fecha inicio</label><input type="date" class="form-control" name="fecha_inicio" required></div>
          <div class="col-6"><label class="form-label">Fecha fin</label><input type="date" class="form-control" name="fecha_fin" required></div>
          <div class="col-12"><label class="form-label">Observaciones</label><textarea class="form-control" name="observaciones" rows="3"></textarea></div>
          <div class="col-12"><label class="form-label">Documento (PDF, opcional)</label><input type="file" class="form-control" name="documento" accept="application/pdf"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Enviar solicitud</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'js/vacations.js' %}"></script>
{% endblock %}

{% extends 'layouts/base.html' %}
{% load static %}

{% block page_title %}Gestión de Vacaciones{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h2 class="mb-0 me-3">
        {% if role == 'manager' %}
            Autorización de Vacaciones a mi cargo
        {% else %}
            Gestión de Vacaciones
        {% endif %}
    </h2>

    {% if role == 'manager' %}
    <a href="{% url 'vacation_form_user' %}" class="btn btn-outline-primary">
        <i class="fa-solid fa-user me-2"></i> Mis Solicitudes Personales
    </a>
    {% endif %}
  </div>

<div class="card p-3">
    <form method="get" class="row g-2 mb-3">
        <div class="col-12 col-md-5">
            <input name="q" type="text" class="form-control" placeholder="Buscar por empleado..." value="{{ q }}">
        </div>
        
        <div class="col-12 col-md-3">
            <select name="estado" class="form-select" onchange="this.form.submit()">
                
                {% if role == 'rh' %}
                    <option value="authorized" {% if estado == 'authorized' %}selected{% endif %}>Por procesar (Autorizadas)</option>
                    <option value="pending" {% if estado == 'pending' %}selected{% endif %}>Pendientes de Jefe</option>
                {% else %}
                    <option value="pending" {% if estado == 'pending' %}selected{% endif %}>Pendientes de aprobar</option>
                    <option value="authorized" {% if estado == 'authorized' %}selected{% endif %}>Mis Autorizadas (Historial)</option>
                {% endif %}
                
                <option value="approved" {% if estado == 'approved' %}selected{% endif %}>Finalizadas</option>
                <option value="rejected" {% if estado == 'rejected' %}selected{% endif %}>Rechazadas</option>
                <option value="todos" {% if estado == 'todos' %}selected{% endif %}>Todas</option>
            </select>
        </div>
        
        <div class="col-12 col-md-2">
            <a href="." class="btn btn-outline-secondary w-100">Limpiar</a>
        </div>
    </form>

    <div class="table-responsive">
      <table id="vac-table" class="table table-sm table-hover align-middle mb-0">
        <thead class="table">
          <tr>
            <th>#</th>
            <th>Empleado</th>
            <th>Tipo</th>
            <th>Fechas</th>
            <th>Días</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in page_obj.object_list %}
          <tr data-id="{{ s.id }}" 
              data-empleado="{{ s.user.get_full_name|default:s.user.username }}" 
              data-tipo="{{ s.tipo_solicitud }}" 
              data-dias="{{ s.total_days }}" 
              data-inicio="{{ s.start_date|date:'d/m/Y' }}"
              data-fin="{{ s.end_date|date:'d/m/Y' }}"
              data-razon="{{ s.reason|default:''|escapejs }}"
              data-estado="{{ s.status }}">
            
            <td>{{ s.id }}</td>
            <td>{{ s.user.get_full_name|default:s.user.username }}</td>
            <td>{{ s.tipo_solicitud }}</td>
            <td>{{ s.start_date|date:"d/m/Y" }} - {{ s.end_date|date:"d/m/Y" }}</td>
            <td class="text-center">{{ s.total_days|default:"-" }}</td>
            
            <td>
                {% with st=s.status %}
                <span class="badge 
                    {% if st == 'approved' %} bg-success
                    {% elif st == 'rejected' %} bg-danger
                    {% elif st == 'authorized' %} bg-info text-dark
                    {% elif st == 'pending' %} bg-warning text-dark
                    {% else %} bg-secondary {% endif %}">
                    
                    {% if st == 'approved' %}
                        Finalizada 
                        {% if s.manager_approver %}
                            <br><small style="font-size:0.75em">(Aut: {{ s.manager_approver.first_name }} {{ s.manager_approver.last_name }})</small>
                        {% endif %}
                    
                    {% elif st == 'rejected' %} 
                        Rechazada

                    {% elif st == 'authorized' %}
                        Autorizada por 
                        {% if s.manager_approver %}
                            {{ s.manager_approver.first_name }} {{ s.manager_approver.last_name }}
                        {% else %}
                            Jefe
                        {% endif %}

                    {% elif st == 'pending' %} 
                        Pendiente de Jefe
                    {% endif %}
                </span>
                {% endwith %}
            </td>

            <td>
              <div class="btn-group">
                {% if role == 'manager' %}
                    {% if s.status == 'pending' %}
                        <button type="button" class="btn btn-sm btn-primary btn-atender"
                                data-bs-toggle="modal" data-bs-target="#modalAtender">
                            Autorizar / Rechazar
                        </button>
                    {% else %}
                        <button class="btn btn-sm btn-outline-secondary btn-ver-detalle" 
                                data-bs-toggle="modal" data-bs-target="#modalDetalleVac">Ver</button>
                    {% endif %}

                {% elif role == 'rh' %}
                    {% if s.status == 'authorized' %}
                        <button type="button" class="btn btn-sm btn-success btn-atender"
                                data-bs-toggle="modal" data-bs-target="#modalAtender">
                            Finalizar / Subir
                        </button>
                    {% elif s.status == 'pending' %}
                        <span class="badge bg-light text-muted border">Esperando Jefe</span>
                    {% else %}
                        <button class="btn btn-sm btn-outline-secondary btn-ver-detalle" 
                                data-bs-toggle="modal" data-bs-target="#modalDetalleVac">Ver</button>
                    {% endif %}
                {% endif %}
                
                <button type="button" class="btn btn-sm btn-outline-primary d-lg-none btn-ver-detalle"
                        data-bs-toggle="modal" data-bs-target="#modalDetalleVac">Info</button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center text-muted py-3">No hay solicitudes en esta categoría.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if page_obj.has_other_pages %}
    <nav class="mt-3">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&estado={{ estado }}&q={{ q }}">Ant</a></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">{{ page_obj.number }}</span></li>
            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&estado={{ estado }}&q={{ q }}">Sig</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<div class="modal fade" id="modalDetalleVac" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle de solicitud <span id="det-id"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-1"><strong>Empleado:</strong> <span id="det-empleado"></span></p>
            <p class="mb-1"><strong>Tipo:</strong> <span id="det-tipo"></span></p>
            <p class="mb-1"><strong>Días:</strong> <span id="det-dias"></span></p>
          </div>
          <div class="col-md-6">
            <p class="mb-1"><strong>Inicio:</strong> <span id="det-inicio"></span></p>
            <p class="mb-1"><strong>Fin:</strong> <span id="det-fin"></span></p>
            <p class="mb-1"><strong>Estado:</strong> <span id="det-estado" class="badge bg-secondary"></span></p>
          </div>
          <div class="col-12">
            <p class="mb-1"><strong>Motivo/Observaciones:</strong></p>
            <div id="det-razon" class="p-2 bg-light rounded text-muted"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalAtender" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="formAtender" enctype="multipart/form-data" method="post">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Atender solicitud <span id="att-id-label"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="req_id" id="att-id">
        
        <div class="alert alert-info py-2">
            {% if role == 'manager' %}
                Estás a punto de <strong>Autorizar</strong> esta solicitud para enviarla a RH.
            {% else %}
                Estás a punto de <strong>Finalizar</strong> esta solicitud (subirla al sistema).
            {% endif %}
        </div>

        <div class="mb-3">
          <label class="form-label">Comprobante (PDF, opcional)</label>
          <input type="file" name="pdf_respuesta" accept="application/pdf" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Comentario (opcional)</label>
          <textarea name="comentario" rows="3" class="form-control" placeholder="Escribe un comentario..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button name="accion" value="rechazar" class="btn btn-danger me-auto" type="submit">Rechazar</button>
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        
        {% if role == 'manager' %}
            <button name="accion" value="aprobar" class="btn btn-primary" type="submit">Autorizar</button>
        {% else %}
            <button name="accion" value="aprobar" class="btn btn-success" type="submit">Finalizar</button>
        {% endif %}
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Manejar botones "Atender"
    const modalAtender = document.getElementById('modalAtender');
    if (modalAtender) {
        modalAtender.addEventListener('show.bs.modal', function(event) {
            const btn = event.relatedTarget;
            const tr = btn.closest('tr');
            
            // Llenar datos
            const id = tr.getAttribute('data-id');
            document.getElementById('att-id').value = id;
            document.getElementById('att-id-label').textContent = '#' + id;
        });
    }

    // 2. Manejar botones "Ver Detalle"
    const modalDetalle = document.getElementById('modalDetalleVac');
    if (modalDetalle) {
        modalDetalle.addEventListener('show.bs.modal', function(event) {
            const btn = event.relatedTarget;
            const tr = btn.closest('tr');

            // Extraer data attributes
            document.getElementById('det-id').textContent = '#' + tr.getAttribute('data-id');
            document.getElementById('det-empleado').textContent = tr.getAttribute('data-empleado');
            document.getElementById('det-tipo').textContent = tr.getAttribute('data-tipo');
            document.getElementById('det-dias').textContent = tr.getAttribute('data-dias');
            document.getElementById('det-inicio').textContent = tr.getAttribute('data-inicio');
            document.getElementById('det-fin').textContent = tr.getAttribute('data-fin');
            document.getElementById('det-razon').textContent = tr.getAttribute('data-razon') || 'Sin comentarios.';
            
            // Estado
            const st = tr.getAttribute('data-estado');
            const badge = document.getElementById('det-estado');
            badge.textContent = st;
            
            // Resetear clases y poner la correcta
            badge.className = 'badge'; 
            if (st === 'approved') badge.classList.add('bg-success');
            else if (st === 'rejected') badge.classList.add('bg-danger');
            else if (st === 'authorized') badge.classList.add('bg-info', 'text-dark');
            else badge.classList.add('bg-warning', 'text-dark');
        });
    }
});
</script>
{% endblock %}
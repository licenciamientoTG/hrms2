{% extends 'layouts/base.html' %}
{% load static %}

{% block page_title %}Solicitudes de vacaciones{% endblock %}

{% block styles %}
<style>
  .min-w-0 { min-width: 0; }

  /* Evitar que celdas muy largas rompan el layout */
  #vac-table th, #vac-table td {
    white-space: normal;
    word-break: break-word;
  }

  @media (max-width: 576px) {
    .page-header-actions .btn-primary { white-space: normal; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h2 class="mb-0 me-3">Solicitudes de vacaciones</h2>
  </div>

  <!-- ðŸ”² Card que contiene TODO: filtros + tabla -->
  <div class="card p-3">

    <!-- Toggle de filtros (solo mÃ³vil) -->
    <button class="btn btn-outline-secondary d-md-none w-100 mb-2"
            type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse"
            aria-expanded="false" aria-controls="filtrosCollapse">
      Filtros
    </button>

    <!-- Filtros -->
    <div class="collapse d-md-block" id="filtrosCollapse">
      <form method="get" class="row g-2 mb-3" id="form-filtros">
        <div class="col-12 col-md-5">
          <input
            id="filtro-q"
            name="q"
            type="text"
            class="form-control"
            placeholder="Buscar por ID o empleado"
            value="{{ q }}"
          >
        </div>

        <div class="col-12 col-md-3">
          <select id="filtro-estado" name="estado" class="form-select">
            <option value="" {% if not estado %}selected{% endif %}>Todos los estados</option>
            <option value="pending"  {% if estado == 'pending'  %}selected{% endif %}>Pendientes</option>
            <option value="approved" {% if estado == 'approved' %}selected{% endif %}>Aprobadas</option>
            <option value="rejected" {% if estado == 'rejected' %}selected{% endif %}>Rechazadas</option>
          </select>
        </div>

        <div class="col-12 col-md-2">
          <select id="filtro-tipo" name="tipo" class="form-select">
            <option value="" {% if not tipo %}selected{% endif %}>Todos los tipos</option>
            <option value="Vacaciones"             {% if tipo == 'Vacaciones'             %}selected{% endif %}>Vacaciones</option>
            <option value="Descanso mÃ©dico"        {% if tipo == 'Descanso mÃ©dico'        %}selected{% endif %}>Descanso mÃ©dico</option>
            <option value="DÃ­as de estudio"        {% if tipo == 'DÃ­as de estudio'        %}selected{% endif %}>DÃ­as de estudio</option>
            <option value="Licencia por maternidad" {% if tipo == 'Licencia por maternidad' %}selected{% endif %}>Licencia por maternidad</option>
          </select>
        </div>

        <div class="col-12 col-md-2">
          <a href="{% url 'vacation_form_admin' %}" class="btn btn-outline-secondary w-100" id="btn-limpiar">
            Limpiar
          </a>
        </div>
      </form>
    </div>


    <!-- Separador opcional -->
    <!-- <hr class="my-2"> -->

    <!-- Tabla (dentro de la MISMA card) -->
    <div class="table-responsive">
      <table id="vac-table" class="table table-sm table-hover align-middle mb-0">
        <thead class="table">
          <tr>
            <th class="text-nowrap">#</th>
            <th class="text-nowrap">Empleado</th>
            <th class="d-none d-lg-table-cell text-nowrap">Tipo</th>
            <th class="text-nowrap">Rango</th>
            <th class="d-none d-md-table-cell text-center text-nowrap">DÃ­as</th>
            <th class="text-nowrap">Estado</th>
            <th class="d-none d-lg-table-cell text-nowrap">Comprobante</th>
            <th class="d-none d-lg-table-cell text-nowrap">InformaciÃ³n</th>
            <th class="text-nowrap">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in page_obj.object_list %}
          <tr
            data-id="{{ s.id }}"
            data-empleado="{{ s.user.get_full_name|default:s.user.username }}"
            data-tipo="{{ s.tipo_solicitud }}"
            data-dias="{{ s.total_days|default:'' }}"
            data-inicio="{{ s.start_date|date:'d/m/Y' }}"
            data-fin="{{ s.end_date|date:'d/m/Y' }}"
            data-estado="{{ s.status }}"
            data-razon="{{ s.reason|default:''|escapejs }}"
          >
            <td>{{ s.id }}</td>

            <td class="text-nowrap">
              {{ s.user.get_full_name|default:s.user.username }}
            </td>

            <!-- Tipo (ya viene bonito por los choices) -->
            <td class="d-none d-lg-table-cell">
              {{ s.tipo_solicitud }}
            </td>

            <!-- Rango -->
            <td class="text-nowrap">
              {{ s.start_date|date:"d/m/Y" }} â€“ {{ s.end_date|date:"d/m/Y" }}
            </td>

            <!-- DÃ­as -->
            <td class="d-none d-md-table-cell text-center">
              {{ s.total_days|default:"-" }}
            </td>

            <!-- Estado -->
            <td>
              {% with st=s.status|default:"pending" %}
                <span class="badge
                  {% if st == 'approved' %} bg-success
                  {% elif st == 'rejected' %} bg-danger
                  {% elif st == 'pending' %} bg-warning text-dark
                  {% else %} bg-secondary {% endif %}">
                  {% if st == 'approved' %}
                    Aprobada
                  {% elif st == 'rejected' %}
                    Rechazada
                  {% elif st == 'pending' %}
                    Pendiente
                  {% else %}
                    {{ st }}
                  {% endif %}
                </span>
              {% endwith %}
            </td>

            <!-- Comprobante -->
            <td class="d-none d-lg-table-cell">
              {% if s.documento %}
                <a href="{{ s.documento.url }}" target="_blank" rel="noopener">Ver PDF</a>
              {% else %}â€”{% endif %}
            </td>

            <!-- Info (abre modal detalle) -->
            <td class="d-none d-lg-table-cell">
              <button type="button" class="btn btn-sm btn-outline-primary btn-ver-detalle"
                      data-bs-toggle="modal" data-bs-target="#modalDetalleVac">
                Ver
              </button>
            </td>

            <!-- Acciones (Atender) -->
            <td>
              <div class="btn-group">
                {% if s.status == 'pending' %}
                  <button type="button" class="btn btn-sm btn-success btn-atender"
                          data-bs-toggle="modal" data-bs-target="#modalAtender">
                    Atender
                  </button>
                {% else %}
                  <button type="button" class="btn btn-sm btn-secondary" disabled>
                    Atendida
                  </button>
                {% endif %}

                <button type="button" class="btn btn-sm btn-outline-primary d-lg-none btn-ver-detalle"
                        data-bs-toggle="modal" data-bs-target="#modalDetalleVac">
                  Info
                </button>
              </div>
            </td>

          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center">Sin solicitudes</td></tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>  {# â† cierra la card que envuelve filtros + tabla #}

  {# PaginaciÃ³n (fuera de la card, igual que en constancias) #}
  {% if page_obj.paginator.num_pages > 1 %}
  <nav aria-label="PaginaciÃ³n" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&estado={{ estado }}&tipo={{ tipo }}">Â«</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Â«</span></li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&estado={{ estado }}&tipo={{ tipo }}">Â»</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Â»</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

{# Modales (sin cambios) #}
<!-- MODAL: Detalle -->
<div class="modal fade" id="modalDetalleVac" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle de solicitud <span id="det-id"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-1"><strong>Empleado:</strong> <span id="det-empleado"></span></p>
            <p class="mb-1"><strong>Tipo:</strong> <span id="det-tipo"></span></p>
            <p class="mb-1"><strong>DÃ­as:</strong> <span id="det-dias"></span></p>
          </div>
          <div class="col-md-6">
            <p class="mb-1"><strong>Inicio:</strong> <span id="det-inicio"></span></p>
            <p class="mb-1"><strong>Fin:</strong> <span id="det-fin"></span></p>
            <p class="mb-1"><strong>Estado:</strong> <span id="det-estado" class="badge"></span></p>
          </div>
          <div class="col-12">
            <p class="mb-1"><strong>Motivo/observaciones:</strong></p>
            <p id="det-razon" class="mb-0 text-muted"></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Atender -->
<div class="modal fade" id="modalAtender" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="formAtender" enctype="multipart/form-data" method="post">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Atender solicitud <span id="att-id-label"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="req_id" id="att-id">
        <div class="mb-3">
          <label class="form-label">Comprobante/Respuesta (PDF, opcional)</label>
          <input type="file" name="pdf_respuesta" accept="application/pdf" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Comentario (opcional)</label>
          <textarea name="comentario" rows="3" class="form-control" placeholder="Opcionalâ€¦"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button name="accion" value="rechazar" class="btn btn-danger me-auto" type="submit">Rechazar</button>
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button name="accion" value="aprobar" class="btn btn-success" type="submit">Aprobar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/vacations.js' %}"></script>
{% endblock %}

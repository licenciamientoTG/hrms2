{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root {
        --tg-sapphire: #2B57A4;
        --tg-celestial: #1197D5;
        --tg-shamrock: #009861;
        --tg-lime: #A9CA48;
    }

    .tg-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .tg-header {
        background-color: var(--tg-sapphire);
        color: white;
        padding: 1.5rem 2rem;
        border-bottom: 4px solid var(--tg-lime);
    }

    .tg-input {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    .tg-input:focus {
        background-color: #fff;
        border-color: var(--tg-sapphire);
        box-shadow: 0 0 0 4px rgba(43, 87, 164, 0.1);
    }

    .btn-tg-primary {
        background-color: var(--tg-sapphire);
        border-color: var(--tg-sapphire);
        color: white;
        font-weight: 600;
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
    }
    .btn-tg-primary:hover {
        background-color: #1e407a;
        color: white;
    }

    .btn-tg-action {
        background-color: var(--tg-lime);
        border-color: var(--tg-lime);
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 8px;
        padding: 0.8rem;
    }
    .btn-tg-action:hover {
        background-color: #98b641;
        color: white;
    }

    .default-reset-panel {
        background-color: #f8faff;
        border: 2px dashed #d1d9e6;
        border-radius: 12px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        transition: all 0.3s;
    }
    .default-reset-panel:hover {
        border-color: var(--tg-celestial);
        background-color: #f0f7ff;
    }
    
    .user-avatar-circle {
        width: 60px; 
        height: 60px; 
        background: rgba(255,255,255,0.2); 
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        border: 2px solid rgba(255,255,255,0.3);
    }
</style>

<div class="container-fluid p-0">
    <div class="mb-4">
        <h1 class="h3 d-inline align-middle">Administración de Accesos</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mt-2">
                <li class="breadcrumb-item"><a href="{% url 'user_dashboard' %}">Usuarios</a></li>
                <li class="breadcrumb-item active">Restablecer Contraseña</li>
            </ol>
        </nav>
    </div>

    <div class="row justify-content-center">
        <div class="col-xl-10 col-xxl-8">
            <div class="card tg-card">
                
                <div class="tg-header d-flex align-items-center gap-3">
                    <div class="user-avatar-circle">
                        {{ target_user.first_name|slice:":1" }}{{ target_user.last_name|slice:":1" }}
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold">{{ target_user.first_name }} {{ target_user.last_name }}</h4>
                        <div class="opacity-75 small">
                            <i class="align-middle me-1" data-feather="user"></i> {{ target_user.username }} 
                            {% if target_user.email %} &bull; {{ target_user.email }} {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body p-4 p-md-5">
                    <div class="row g-5">
                        
                        <div class="col-md-7">
                            <div class="d-flex align-items-center mb-4">
                                <div class="bg-light text-primary rounded p-2 me-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="var(--tg-sapphire)" class="bi bi-pencil-fill" viewBox="0 0 16 16">
                                        <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-0 text-dark">Nueva Contraseña Manual</h5>
                                    <small class="text-muted">Ingresa una contraseña personalizada.</small>
                                </div>
                            </div>

                            <form method="post">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary small">NUEVA CONTRASEÑA</label>
                                    {{ form.new_password1 }}
                                    <script>document.getElementById("{{ form.new_password1.id_for_label }}").classList.add("form-control", "tg-input");</script>
                                    <div class="text-danger small mt-1">{{ form.new_password1.errors }}</div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold text-secondary small">CONFIRMAR CONTRASEÑA</label>
                                    {{ form.new_password2 }}
                                    <script>document.getElementById("{{ form.new_password2.id_for_label }}").classList.add("form-control", "tg-input");</script>
                                    <div class="text-danger small mt-1">{{ form.new_password2.errors }}</div>
                                </div>

                                <div class="d-flex gap-2 pt-2">
                                    <button class="btn btn-tg-primary px-4" type="submit">Guardar Cambios</button>
                                    <a href="{% url 'user_dashboard' %}" class="btn btn-light border">Cancelar</a>
                                </div>
                            </form>
                        </div>

                        <div class="col-md-5">
                            <div class="default-reset-panel p-4">
                                <div class="mb-3 text-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
                                        <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
                                    </svg>
                                </div>
                                
                                <h5 class="fw-bold" style="color: var(--tg-sapphire);">Reestablecer a Default</h5>
                                <p class="small text-muted mb-4">
                                    Esta acción reiniciará la contraseña a la combinación estándar:<br>
                                    <span class="badge bg-light text-dark border mt-2">#Reloj + Fecha Nacimiento (AAMMDD)</span>
                                </p>

                                <form id="form-reset-default" action="{% url 'reset_password_default' target_user.id %}" method="POST" class="w-100">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-tg-action w-100 shadow-sm" onclick="confirmarReset()">
                                        APLICAR DEFAULT
                                    </button>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmarReset() {
        Swal.fire({
            title: '¿Estás seguro?',
            html: "Se eliminará la contraseña actual y se aplicará la <b>contraseña por defecto</b>.<br><br>El usuario será forzado a cambiarla en su próximo inicio de sesión.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#2B57A4', // Azul Sapphire (Marca)
            cancelButtonColor: '#6c757d',  // Gris estándar
            confirmButtonText: 'Sí, reestablecer',
            cancelButtonText: 'Cancelar',
            reverseButtons: true, // Pone el cancelar a la izquierda (más seguro)
            focusCancel: true     // Pone el foco en cancelar por seguridad
        }).then((result) => {
            if (result.isConfirmed) {
                // Si confirma, enviamos el formulario manualmente
                document.getElementById('form-reset-default').submit();
            }
        })
    }
</script>
{% endblock %}
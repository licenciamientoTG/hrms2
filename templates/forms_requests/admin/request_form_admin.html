{% extends 'layouts/base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center mb-4">
    <h2 class="mb-0">Solicitudes de constancias</h2>
    <div class="ms-auto d-flex gap-2">
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPlantillas">
        Plantilla de constancias
      </button>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCarta">
        Constancia laboral
      </button>
    </div>
  </div>

<!-- Filtros -->
<div class="card p-3">
  <div class="row g-2 mb-3">
      <div class="col-md-5">
        <input id="filtro-q" type="text" class="form-control" placeholder="Buscar por ID o empleado">
      </div>

      <div class="col-md-3">
        <select id="filtro-estado" class="form-select">
          <option value="">Todos los estados</option>
          <option value="pendiente">Pendientes</option>
          <option value="completada">Completadas</option>
          <option value="rechazada">Rechazadas</option>
        </select>
      </div>

      <div class="col-md-2">
        <button id="btn-limpiar" class="btn btn-outline-secondary w-100" type="button">Limpiar</button>
      </div>

      <div class="col-md-2">
        <a href="{% url 'admin_forms' %}" id="btn-todas" class="btn btn-outline-primary w-100">Todas las solicitudes</a>
      </div>
  </div>
  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
      <thead class="table">
        <tr>
          <th>#</th>
          <th>Solicitante</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>PDF</th>
          <th>Informaci√≥n</th>
          <th>Tipo</th>
        </tr>
      </thead>
      <tbody id="tabla-solicitudes">
        {% for s in page_obj.object_list %}
          <tr
            data-id="{{ s.id }}"
            data-empleado="{{ s.empleado.get_full_name|default:s.empleado.username }}"
            data-estado="{% if s.estado == 'en progreso' %}pendiente{% else %}{{ s.estado }}{% endif %}"
            data-estado-label="{% if s.estado == 'en progreso' %}En proceso{% else %}{{ s.estado|title }}{% endif %}"
          >
            <td>{{ s.id }}</td>
            <td>{{ s.empleado.get_full_name|default:s.empleado.username }}</td>
            <td class="text-nowrap">{{ s.fecha_solicitud|date:"d/m/Y H:i" }}</td>
            <td>
              {% with st=s.estado %}
                {% if st == 'completada' %}
                  <span class="badge bg-success">Completada</span>
                {% elif st == 'rechazada' %}
                  <span class="badge bg-danger">Rechazada</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Pendiente</span>
                {% endif %}
              {% endwith %}
            </td>
            <td>
              {% if s.estado == "rechazada" %}
                -
              {% elif s.pdf_respuesta and s.pdf_respuesta.name %}
                <a href="{{ s.pdf_respuesta.url }}" target="_blank" rel="noopener">Ver PDF</a>
              {% else %}
                <button type="button"
                        class="btn btn-sm btn-success btn-responder"
                        data-id="{{ s.id }}"
                        data-user="{{ s.empleado.get_full_name|default:s.empleado.username|escape }}">
                  Responder
                </button>
              {% endif %}
            </td>
            <td>
              <button type="button"
                      class="btn btn-sm btn-outline-primary btn-ver-solicitud"
                      data-url="{% url 'guarderia_detalle' s.id %}">
                Ver
              </button>
            </td>
            <td>
              <span class="badge bg-info text-dark">Guarder√≠a</span>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7">Sin registros</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

  <!-- Paginaci√≥n -->
  {% if page_obj and page_obj.paginator.num_pages > 1 %}
  <nav aria-label="Paginaci√≥n" class="mt-3">
    <ul class="pagination mb-0">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&estado={{ estado }}">¬´ Anterior</a>
      </li>
      {% endif %}
      
      <li class="page-item disabled">
        <span class="page-link">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      </li>
      
      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&estado={{ estado }}">Siguiente ¬ª</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<div class="modal fade" id="modalDetalleSolicitud" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Detalle de solicitud <span id="det-id"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-1"><strong>Solicitante:</strong> <span id="det-empleado"></span></p>
            <p class="mb-1"><strong>Fecha:</strong> <span id="det-fecha"></span></p>
            <p class="mb-1"><strong>D√≠as laborales:</strong> <span id="det-dias"></span></p>
            <p class="mb-1"><strong>Horario:</strong> <span id="det-horario"></span></p>
          </div>
          <div class="col-md-6">
            <p class="mb-1"><strong>Guarder√≠a:</strong> <span id="det-guarderia"></span></p>
            <p class="mb-1"><strong>Direcci√≥n:</strong> <span id="det-direccion"></span></p>
            <p class="mb-1"><strong>Menor:</strong> <span id="det-menor"></span></p>
            <p class="mb-1"><strong>Estado:</strong> <span id="det-estado" class="badge"></span></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% comment %} modal para subir el documento {% endcomment %}
<div class="modal fade" id="modalResponder" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="formResponder" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title">Responder solicitud <span id="resp-id-label"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="resp-id">
        <div class="mb-3 text-start">
          <label class="form-label">Archivo PDF de respuesta</label>
          <input type="file" name="pdf_respuesta" accept="application/pdf" class="form-control" required>
          <div class="form-text">Se enviar√° al solicitante y se marcar√° como completada.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-rechazar" class="btn btn-danger me-auto" type="button">Rechazar</button>
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" type="submit">Enviar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalCarta" tabindex="-1" aria-labelledby="modalCartaLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-body">
        <form id="formCarta" class="row g-3">
          <!-- N√∫mero de reloj (OBLIGATORIO) -->
          <div class="col-md-6">
            <label class="form-label">N√∫mero de reloj</label>
            <div class="position-relative">
              <input type="text"
                    inputmode="numeric" pattern="[0-9]*"
                    name="employee_number" id="employeeNumber"
                    class="form-control" placeholder="Ej. 1234" autocomplete="off">
              <span id="iconEstado" class="position-absolute top-50 end-0 translate-middle-y me-3 d-none">
              </span>
            </div>
            <div class="form-text" id="ayudaNumero"></div>
          </div>
        </form>

        <hr class="my-3">
        <div class="ratio ratio-4x3 border rounded">
          <!-- Vista previa PDF -->
          <iframe id="previewCarta" src="" title="Vista previa" style="width:100%; height:100%; border:0;"></iframe>
        </div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>

<!-- Modal: Editor r√°pido con vista previa en vivo -->
<div class="modal fade" id="modalPlantillas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar / Imprimir constancia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- ‚úÖ GET + target=iframe: no hace falta CSRF -->
      <form id="formPlantillas"
            class="modal-body"
            method="get"
            action="{% url 'constancia_preview' %}"
            target="plantillaPreview">

        <div class="row g-3">
          <div class="col-lg-5">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Tipo</label>
                <select class="form-select" name="tipo">
                  <option value="laboral" selected>Constancia laboral</option>
                  <option value="especial">Constancia especial</option>
                </select>
              </div>

              <div class="col-4">
                <label class="form-label">N. de empleado</label>
                <input class="form-control" name="numero" placeholder="00000">
              </div>
              <div class="col-8">
                <label class="form-label">Nombre completo</label>
                <input class="form-control" name="nombre" placeholder="Nombre del empleado">
              </div>
              <div class="col-12">
                <label class="form-label">Empresa</label>
                <input class="form-control" name="empresa" placeholder="(EMPRESA)">
              </div>


              <div class="col-6">
                <label class="form-label">Departamento</label>
                <input class="form-control" name="departamento" placeholder="(DEPARTAMENTO)">
              </div>
              <div class="col-6">
                <label class="form-label">Equipo</label>
                <input class="form-control" name="equipo" placeholder="(EQUIPO)">
              </div>

              <div class="col-6">
                <label class="form-label">Puesto</label>
                <input class="form-control" name="puesto" placeholder="(PUESTO)">
              </div>
              <div class="col-6">
                <label class="form-label">Fecha de inicio</label>
                <input class="form-control" name="antiguedad" placeholder="(FECHA DE INICIO)">
              </div>

              <div class="col-4">
                <label class="form-label">NSS</label>
                <input class="form-control" name="nss" placeholder="(NSS)">
              </div>
              <div class="col-4">
                <label class="form-label">CURP</label>
                <input class="form-control" name="curp" placeholder="(CURP)">
              </div>
              <div class="col-4">
                <label class="form-label">RFC</label>
                <input class="form-control" name="rfc" placeholder="(RFC)">
              </div>
              <div class="col-6">
                <label class="form-label">Sueldo</label>
                <input class="form-control" name="sueldo" placeholder="(SUELDO)">
              </div>

              <div class="col-6">
                <label class="form-label">Fecha (opcional)</label>
                <input class="form-control" name="fecha_hoy" placeholder="dd/mm/aaaa">
              </div>
              <div class="col-12">
              </div>
            </div>
          </div>

          <!-- Vista previa a la derecha -->
          <div class="col-lg-7">
            <div class="ratio ratio-4x3 border rounded">
              <iframe id="plantillaPreview"
              name="plantillaPreview" 
              title="Vista previa constancia"
              style="width:100%; height:100%; border:0;"></iframe>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/forms.js' %}"></script>
<script>
(function () {
  const buildURL = () => {
    const form = document.getElementById('formCarta');
    const params = new URLSearchParams();
    for (const el of form.elements) {
      if (!el.name) continue;
      const v = (el.value || '').trim();
      if (v) params.append(el.name, v);
    }
    // base = tu ruta a la vista que genera el PDF
    const base = "{% url 'carta_recomendacion' %}";
    return `${base}?${params.toString()}`;
  };

  // Carga previa al abrir el modal
  const modal = document.getElementById('modalCarta');

  // Si tienes un bot√≥n de ‚ÄúVista previa‚Äù, puedes volver a cargar:
  const btnPreview = document.getElementById('btnPreview');
  if (btnPreview) {
    btnPreview.addEventListener('click', () => {
      document.getElementById('previewCarta').src = buildURL();
    });
  }
})();

(function () {
  function debounce(fn, delay){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; }

  const inputNum  = document.getElementById('employeeNumber');
  const ayuda     = document.getElementById('ayudaNumero');
  const iconWrap  = document.getElementById('iconEstado');

  const iframe       = document.getElementById('previewCarta');
  const modal        = document.getElementById('modalCarta');

  let valido = false;
  let modalAbierto = false;
  let ultimoNumRenderizado = null;  // para no recargar el mismo PDF una y otra vez

  function setEstado(ok, texto){
    iconWrap.classList.remove('d-none');
    inputNum.classList.remove('is-valid','is-invalid');
    ayuda.textContent = texto || '';


  }

  function toggle(enable){
  }

  function buildURL(dl=false){
    const num = (inputNum.value || '').trim();
    const params = new URLSearchParams();
    params.append('employee_number', num);
    if (dl) params.append('dl','1');
    return "{% url 'carta_recomendacion' %}" + "?" + params.toString();
  }

  function renderPreviewSiProcede(){
    if (!valido || !modalAbierto) return;
    const num = (inputNum.value || '').trim();
    if (!num || num === ultimoNumRenderizado) return; // evita recargar si no cambi√≥
    ultimoNumRenderizado = num;
    iframe.src = buildURL(false);
  }

  async function validar(){
    valido = false;
    const num = (inputNum.value || '').trim();
    if (!num){ iconWrap.classList.add('d-none'); ayuda.textContent=''; toggle(false); ultimoNumRenderizado=null; return; }
    if (!/^\d+$/.test(num)){ setEstado(false,'Solo n√∫meros.'); toggle(false); ultimoNumRenderizado=null; return; }

    try{
      const url = "{% url 'validar_empleado_numero' %}?num=" + encodeURIComponent(num);
      const r = await fetch(url, {credentials:'same-origin'});
      const data = await r.json();

      if (data.exists){
        setEstado(true, 'Empleado: ' + data.name);
        valido = true;
        toggle(true);
        renderPreviewSiProcede();   // üëà auto-cargar vista previa al validar OK
      } else {
        setEstado(false,'No existe ese n√∫mero de reloj.');
        toggle(false);
        ultimoNumRenderizado = null;
      }
    }catch(e){
      console.error(e);
      setEstado(false,'Error consultando el servidor.');
      toggle(false);
      ultimoNumRenderizado = null;
    }
  }

  inputNum.addEventListener('input', debounce(validar, 300));

  // Control del estado del modal para no renderizar cuando est√° cerrado
  modal.addEventListener('shown.bs.modal', ()=>{
    modalAbierto = true;
    toggle(false);
    ultimoNumRenderizado = null;
    if (iframe) iframe.removeAttribute('src'); // limpia
  });
  modal.addEventListener('hidden.bs.modal', ()=>{
    modalAbierto = false;
  });
})();

function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

document.getElementById('btn-rechazar')?.addEventListener('click', async (ev) => {
  ev.preventDefault();
  const id = document.getElementById('resp-id').value;
  if (!id) return;

  const comentario = (document.getElementById('rechazo-comentario')?.value || '').trim();

  try {
    const res = await fetch(`/forms_requests/guarderia/${id}/rechazar/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: (() => {
        const fd = new FormData();
        fd.append('comentario', comentario);
        return fd;
      })()
    });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.error || 'Error');

    // Cierra modal y refresca la lista (o recarga p√°gina)
    bootstrap.Modal.getInstance(document.getElementById('modalResponder'))?.hide();
    // Si tienes una funci√≥n que refresca la tabla, ll√°mala aqu√≠.
    // Si no, recarga:
    location.reload();

  } catch (err) {
    console.error(err);
    alert('No se pudo rechazar la solicitud.');
  }
});

(function(){
  const modal  = document.getElementById('modalPlantillas');
  const form   = document.getElementById('formPlantillas');
  const iframe = document.getElementById('plantillaPreview');
  if(!modal || !form || !iframe) return;

  const debounce = (fn, ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };
  const refresh  = () => form.requestSubmit ? form.requestSubmit() : form.submit();

  // Cargar al abrir
  modal.addEventListener('shown.bs.modal', refresh);

  // Auto-actualizar la vista previa al escribir / cambiar
  form.addEventListener('input',  debounce(refresh, 300));
  form.addEventListener('change', debounce(refresh, 300));

})();
</script>
{% endblock %}

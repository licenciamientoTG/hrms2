{% extends 'layouts/base.html' %}
{% load static %}

{% block page_title %}Solicitudes de constancias{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Solicitudes de constancias</h1>

    <!-- Barra de búsqueda -->
    <input type="text" id="formSearch" class="form-control search-bar" placeholder="Buscar formulario...">

    <!-- Tabs -->
    <div class="tab-container mb-3">
        <div class="tab active" id="tab-disponibles">Disponibles</div>
        <div class="tab" id="tab-en-proceso">En proceso</div>
        <div class="tab" id="tab-completados">Completados</div>
    </div>

    <!-- DISPONIBLES -->
    <div id="contenedor-disponibles">
        <div class="form-list" id="list-disponibles">
            <div class="form-item mb-3">
                <i class="form-icon bi bi-file-earmark-text-fill"></i>
                <div class="form-name">Constancia laboral
                    <p style="font-size: 0.7rem;">En caso de requerir datos adicionales favor de pasar a Capital Humano</p>
                </div>
                <div class="form-actions">
                    <a href="{% url 'constancia_laboral' %}" target="_blank" class="btn btn-outline-primary">Visualizar</a>
                </div>
            </div>

            <div class="form-item mb-3">
                <i class="form-icon bi bi-file-earmark-text-fill"></i>
                <div class="form-name">Constancia especial
                    <p style="font-size: 0.7rem;">En caso de requerir datos adicionales favor de pasar a Capital Humano</p>
                </div>
                <div class="form-actions">
                    <a href="{% url 'constancia_especial' %}" target="_blank" class="btn btn-outline-primary">Visualizar</a>
                </div>
            </div>
            <div class="form-item mb-3">
                <i class="form-icon bi bi-file-earmark-text-fill"></i>
                <div class="form-name">Constancia de guardería</div>
                <div class="form-actions">
                    <a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalGuarderia">Solicitar</a>
                </div>
            </div>
        </div>
    </div>

    <!-- EN PROCESO -->
    <div id="contenedor-en-proceso" style="display: none;">
        {% if solicitud_pendiente %}
        <div class="card mb-3">
            <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Solicitud Constancia de guardería</h5>
                <span class="badge bg-warning text-dark">Pendiente</span>
            </div>

            <div class="row mt-3 text-start">
                <div class="col-md-6">
                <p class="mb-1"><strong>Fecha de envío:</strong> {{ solicitud_pendiente.fecha_solicitud|date:"d/m/Y H:i" }}</p>
                <p class="mb-1"><strong>Días laborales:</strong> {{ solicitud_pendiente.dias_laborales|default:"—" }}</p>
                <p class="mb-1"><strong>Horario:</strong> {{ solicitud_pendiente.hora_entrada|time:"H:i" }}–{{ solicitud_pendiente.hora_salida|time:"H:i" }}</p>
                </div>
                <div class="col-md-6">
                <p class="mb-1"><strong>Guardería:</strong> {{ solicitud_pendiente.nombre_guarderia }}</p>
                <p class="mb-1"><strong>Dirección:</strong> {{ solicitud_pendiente.direccion_guarderia }}</p>
                <p class="mb-1"><strong>Menor:</strong> {{ solicitud_pendiente.nombre_menor }} ({{ solicitud_pendiente.nacimiento_menor|date:"d/m/Y" }})</p>
                </div>
            </div>
            </div>
        </div>
        {% else %}
        <div class="form-list">
            <div class="form-item mb-3">
            <i class="form-icon bi bi-file-earmark-text-fill"></i>
            <div class="form-name">No tienes solicitudes en proceso.</div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- COMPLETADOS -->
    <div id="contenedor-completados" style="display: none;">
        {% if solicitudes_anteriores %}
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="text-start">Fecha</th>
                        <th class="text-start">Estado</th>
                        <th class="text-center">PDF</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in solicitudes_anteriores %}
                    <tr>
                        <td class="text-start text-nowrap">
                            {{ s.fecha_solicitud|date:"d/m/Y H:i" }}
                        </td>
                        <td class="text-start">
                            {% with estado=s.estado %}
                                <span class="badge
                                    {% if estado == 'completada' %} bg-success
                                    {% elif estado == 'rechazada' %} bg-danger
                                    {% else %} bg-warning text-dark {% endif %}">
                                    {{ estado|title }}
                                </span>
                            {% endwith %}
                        </td>
                        <td class="text-center">
                            {% if s.pdf_respuesta %}
                                <a class="btn btn-link btn-sm p-0" href="{{ s.pdf_respuesta.url }}" target="_blank" rel="noopener">
                                    Ver
                                </a>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="form-list">
            <div class="form-item mb-3">
            <i class="form-icon bi bi-file-earmark-text-fill"></i>
            <div class="form-name">No tienes solicitudes completadas.</div>
            </div>
        </div>
        {% endif %}
    </div>

</div>

<div class="modal fade" id="modalGuarderia" tabindex="-1" aria-labelledby="modalGuarderiaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formGuarderia" method="POST" data-url="{% url 'guardar_constancia_guarderia' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modalGuarderiaLabel">Constancia de guardería</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
        <h5>Días de descanso</h5>
            <div class="row">
                <div class="col-6">
                    {% for dia in dias_semana|slice:":4" %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="dias_laborales" value="{{ dia }}" id="dia_{{ forloop.counter }}">
                        <label class="form-check-label" for="dia_{{ forloop.counter }}">{{ dia }}</label>
                    </div>
                    {% endfor %}
                </div>
                <div class="col-6">
                    {% for dia in dias_semana|slice:"4:" %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="dias_laborales" value="{{ dia }}" id="dia_{{ forloop.counter }}">
                        <label class="form-check-label" for="dia_{{ forloop.counter }}">{{ dia }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="mb-3 d-flex gap-2">
            <div class="w-50">
                <label class="form-label">Hora de entrada</label>
                <input type="time" class="form-control" name="hora_entrada" required>
            </div>
            <div class="w-50">
                <label class="form-label">Hora de salida</label>
                <input type="time" class="form-control" name="hora_salida" required>
            </div>
        </div>
          <div class="mb-3">
            <label for="nombre_guarderia" class="form-label">Nombre de la guardería</label>
            <input type="text" class="form-control" id="nombre_guarderia" name="nombre_guarderia" required>
          </div>
          <div class="mb-3">
            <label for="direccion_guarderia" class="form-label">Dirección de la guardería</label>
            <textarea class="form-control" id="direccion_guarderia" name="direccion_guarderia" required></textarea>
          </div>
          <div class="mb-3">
            <label for="nombre_menor" class="form-label">Nombre del menor</label>
            <input type="text" class="form-control" id="nombre_menor" name="nombre_menor" required>
          </div>
          <div class="mb-3">
            <label for="nacimiento_menor" class="form-label">Fecha de nacimiento del menor</label>
            <input type="date" class="form-control" id="nacimiento_menor" name="nacimiento_menor" required max="{{today|date:'Y-m-d'}}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" >Solicitar constancia</button>
        </div>
      </div>
    </form>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script src="{% static 'js/forms.js' %}"></script>
{% endblock %}

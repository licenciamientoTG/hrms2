{% extends "layouts/base.html" %}
{% load static %}
{% block page_title %}{{ survey.title|default:"Encuesta sin t√≠tulo" }}{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/survey.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
  <!-- Scripts con datos JSON (solo para encuestas existentes) -->
  {% if survey and survey.id %}
    <script id="builder-data" type="application/json">{{ builder_json|safe }}</script>
    <script id="settings-data" type="application/json">{{ settings_json|safe }}</script>
    <script id="audience-data" type="application/json">{{ audience_json|safe }}</script>
  {% endif %}

  <!-- Encabezado superior -->
  <div class="builder-top"> 
    <div class="builder-head">
      <!-- T√≠tulo: vista y edici√≥n -->
      <div id="titleBox"
          class="title-box"
          data-survey-id="{{ survey.id|default:'new' }}"
          data-default-title="Encuesta sin t√≠tulo">
        <!-- Vista (texto + l√°piz) -->
        <div class="title-view" id="titleView">
          <span class="title-text" data-title-target="header">
            {{ survey.title|default:"Encuesta sin t√≠tulo" }}
          </span>
          <button type="button" class="edit-btn" id="titleEditBtn" aria-label="Editar t√≠tulo">
            <!-- √≠cono de l√°piz simple (SVG inline) -->
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 
                      7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 
                      1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
            </svg>
          </button>
        </div>

        <!-- Edici√≥n (input con label estilo "chip") -->
        <div class="title-edit" id="titleEdit" hidden>
          <label class="title-label" for="surveyTitleInput">T√≠tulo</label>
          <input id="surveyTitleInput" class="title-input" type="text"
                maxlength="120" autocomplete="off" />
          <div class="title-actions">
            <button type="button" class="btn-ghost" id="titleCancelBtn">Cancelar</button>
            <button type="button" class="btn-primary" id="titleSaveBtn">Guardar</button>
          </div>
        </div>
      </div>

      <span id="statusPill" class="status-pill off" role="button" tabindex="0" aria-pressed="false">Desactivada</span>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs builder-tabs px-3 mt-2" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-content" type="button">CONTENIDO</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-settings" type="button">AJUSTES</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-content">
      <div
        class="sections-strip" id="sectionsStrip"
        data-survey-id="{{ survey.id|default:'new' }}"
        data-create-section-url="#"
        data-sections-options-url="#"
      >
        {% comment %}
        Para encuestas nuevas, esto estar√° vac√≠o y se generar√° desde JavaScript.
        Para encuestas existentes, esto se poblar√° desde los datos JSON.
        {% endcomment %}
        {% for section in sections %}
          {% include "surveys/admin/_section.html" with section=section %}
        {% endfor %}

        <div class="section-col" id="newSectionCol">
          <div class="new-section-card" id="btnNewSection">Nueva secci√≥n</div>
        </div>
      </div>
    </div>

    <!-- =================== AJUSTES (solo UI) =================== -->
    <div class="tab-pane fade" id="tab-settings">
    <form id="surveySettingsForm" class="p-3"
          data-survey-id="{{ survey.id|default:'new' }}"
          data-meta-url="{% url 'survey_audience_meta' %}"
          data-preview-url="{% url 'survey_audience_preview' %}"
          data-import-create-url="{% url 'survey_import_create' %}"
          {% if survey %}
          data-import-update-url="{% url 'survey_import_update' survey.id %}"
          {% endif %}
          data-dashboard-url="{% url 'survey_dashboard_admin' %}">

        <!-- Automensaje -->
        <div class="card mb-3 rounded-3">
          <div class="card-body">
            <div class="fw-semibold mb-2">Mensaje</div>
            <textarea id="autoMessage" rows="2" class="form-control rounded-3"
              placeholder="Favor de escribir un mensaje...">{{ survey.auto_message|default:"" }}</textarea>
            <div class="form-text">Se enviar√° al finalizar la encuesta.</div>
          </div>
        </div>

        <!-- Audiencia -->
        <div class="card mb-3 rounded-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">Audiencia</div>
              <span class="badge bg-light text-dark">Alcance: <span id="reachCount">‚Äî</span></span>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="audience_mode" id="audAll" value="all" checked>
              <label class="form-check-label" for="audAll">Todos los usuarios</label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="audience_mode" id="audSeg" value="segmented">
              <label class="form-check-label" for="audSeg">Segmentar</label>
            </div>

            <!-- Segmentaci√≥n -->
            <div id="segmentationBlock" class="mt-3 border rounded p-3 d-none">
              <!-- Usuario (chips + buscador) -->
              <label class="form-label">Usuario</label>
              <div class="input-group mb-2">
                <div id="selectedUsers" class="chips-wrap form-control" aria-live="polite">
                  <!-- aqu√≠ se mostrar√°n chips de usuarios -->
                </div>
              </div>
              <div class="input-group mb-3">
                <input type="text" id="userSearch" class="form-control" placeholder="Buscar usuarios‚Ä¶" data-url="{% url 'survey_audience_user_search' %}">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"></button>
                <ul class="dropdown-menu dropdown-menu-end" id="userSearchMenu" style="max-height:260px;overflow:auto">
                  <!-- aqu√≠ aparecer√°n resultados -->
                </ul>
              </div>

              <!-- Departamento -->
              <div class="mb-3">
                <label class="form-label">Departamento</label>
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">üîé</span>
                    <input id="searchDeps" type="text" class="form-control" placeholder="Buscar departamento‚Ä¶">
                  </div>
                <div id="fDepartments" class="list-group border rounded-3 overflow-auto" style="max-height:220px"></div>
              </div>

              <!-- Posici√≥n -->
              <div class="mb-3">
                <label class="form-label">Posici√≥n</label>
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">üîé</span>
                    <input id="searchPos" type="text" class="form-control" placeholder="Buscar posici√≥n‚Ä¶">
                  </div>
                <div id="fPositions" class="list-group border rounded-3 overflow-auto" style="max-height:220px"></div>
              </div>

              <!-- Ubicaci√≥n -->
              <div class="mb-1">
                <label class="form-label">Ubicaci√≥n</label>
                  <!-- NUEVO: buscador de ubicaciones -->
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">üîé</span>
                    <input id="searchLocs" type="text" class="form-control" placeholder="Buscar ubicaci√≥n‚Ä¶">
                  </div>
                <div id="fLocations" class="list-group border rounded-3 overflow-auto" style="max-height:220px"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Respuestas -->
        <div class="card mb-4 rounded-3">
          <div class="card-body">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isAnonymous" {% if survey.is_anonymous %}checked{% endif %}>
              <label class="form-check-label" for="isAnonymous">Esta encuesta es an√≥nima</label>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="d-flex flex-wrap gap-2 justify-content-between">
          <!-- Izquierda -->
          <a href="{% url 'survey_dashboard_admin' %}"
            class="btn btn-outline-danger"
            id="btnCancelSurvey">
            Cancelar
          </a>

          <!-- Derecha -->
          <div class="btn-group">
            <button type="submit" class="btn btn-primary" id="btnPublish">
              {% if survey and survey.id %}Actualizar{% else %}Publicar{% endif %}
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<template id="tpl-section">
  <div class="section-col" data-section-id="">
    <div class="section-card">
      <div class="section-head">
        <div class="sec-title-wrap d-flex align-items-center gap-2">
          <!-- Vista -->
          <span class="sec-title"
                data-bind="sec-title"
                data-section-title-view
                tabindex="0"
                title="Haz clic o presiona Enter/F2 para renombrar">
            Secci√≥n
          </span>
          <!-- Edici√≥n -->
          <input type="text"
                 class="form-control form-control-sm sec-title-input"
                 data-section-title-edit
                 maxlength="120"
                 hidden
                 aria-label="Nombre de la secci√≥n">
        </div>

        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm"
                  data-bs-toggle="dropdown" data-bs-display="static">‚ãÆ</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <!-- Sin ‚ÄúRenombrar‚Äù -->
            <li>
              <button class="dropdown-item text-danger"
                      data-action="sec.delete" data-id="">
                Eliminar
              </button>
            </li>
          </ul>
        </div>
      </div>

      <div class="q-list" data-bind="q-list"></div>

      <div class="px-3 pb-2">
        <a class="link-add" data-add-question data-section="">Nueva pregunta</a>
      </div>

      <div class="section-foot">
        <div class="d-flex align-items-center gap-2">
          <span data-bind="sec-after-label">Despu√©s de la secci√≥n</span>
          <div class="dropdown">
            <button class="btn btn-light btn-sm dropdown-toggle"
                    type="button" data-section-jump data-section=""
                    data-bs-toggle="dropdown">
              Ir a la siguiente secci√≥n
            </button>
            <ul class="dropdown-menu dropdown-menu-end"
                data-jump-menu data-section=""></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>


<template id="tpl-question">
  <div class="q-card" data-question-id="" data-type="" data-required="">
    <div class="d-flex justify-content-between align-items-center">
      <div class="q-title" data-bind="q-title">Pregunta</div>
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown" data-bs-display="static">‚ãÆ</button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item text-danger" data-action="q.delete" data-id="">Eliminar</button></li>
        </ul>
      </div>
    </div>
    <div class="q-footer"></div>
  </div>
</template>

<!-- Modal igual que antes... -->
<div class="modal fade" id="qEditor" tabindex="-1" data-bs-backdrop="true" data-bs-focus="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar pregunta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-lg-8">
            <div class="mb-3">
              <label class="form-label">Descripci√≥n</label>
              <input id="qeTitle" class="form-control" placeholder="Pregunta">
            </div>

            <div id="qeOptionsWrap" class="mb-3 d-none">
              <div class="d-flex align-items-center gap-2 mb-2">
                <span class="fw-semibold">Opciones</span>
              </div>
              <div id="qeOptionsList"></div>
              <button id="qeAddOption" type="button" class="btn btn-outline-primary btn-sm mt-2">Nueva opci√≥n</button>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="fw-semibold mb-2">Tipo de respuesta</div>
            <div class="list-group" id="qeTypeList">
              <button type="button" class="list-group-item list-group-item-action" data-type="text">Texto</button>
              {% comment %} <button type="button" class="list-group-item list-group-item-action" data-type="decimal">N√∫mero decimal</button> {% endcomment %}
              <button type="button" class="list-group-item list-group-item-action" data-type="integer">N√∫mero entero</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="single">Opciones (selecci√≥n √∫nica)</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="multiple">Opciones (selecci√≥n m√∫ltiple)</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="rating">Calificaci√≥n</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="assessment">Evaluaci√≥n</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="frecuency">Frecuencia</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="none">Sin respuesta</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer flex-column flex-sm-row gap-2">
        <div class="me-auto d-flex align-items-center gap-4">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="qeRequired">
            <label class="form-check-label" for="qeRequired">Obligatoria</label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="qeBranch" disabled style="display: none;">
            <label class="form-check-label" for="qeBranch" style="display: none;">Ir a la secci√≥n seg√∫n la respuesta</label>
          </div>
        </div>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="qeSave">Guardar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="{% static 'js/survey.js' %}"></script>
{% endblock %}
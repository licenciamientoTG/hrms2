{% extends "layouts/base.html" %}
{% load static %}
{% block page_title %}{{ survey.title|default:"Encuesta sin título" }}{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/survey.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid p-0">

  <!-- Top -->
  <div class="builder-top">
    <div class="builder-head">
      <a href="{% url 'survey_dashboard_admin' %}" class="btn btn-light btn-sm me-1">←</a>
      <div class="fs-5 fw-semibold">{{ survey.title|default:"Encuesta sin título" }}</div>
      <span id="statusPill" class="status-pill off" role="button" tabindex="0" aria-pressed="false">Desactivada</span>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs builder-tabs px-3 mt-2" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-content" type="button">CONTENIDO</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-settings" type="button">AJUSTES</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-content">
      <div
        class="sections-strip" id="sectionsStrip"
        data-survey-id="{{ survey.id }}"
        data-create-section-url="#"
        data-sections-options-url="#"
      >
        {% for section in sections %}
          {% include "surveys/admin/_section.html" with section=section %}
        {% endfor %}

        <div class="section-col" id="newSectionCol">
          <div class="new-section-card" id="btnNewSection">Nueva sección</div>
        </div>
      </div>
    </div>

    <!-- =================== AJUSTES (solo UI) =================== -->
    <div class="tab-pane fade" id="tab-settings">
      <form id="surveySettingsForm" class="p-3">

        <!-- Automensaje -->
        <div class="card mb-3 rounded-3">
          <div class="card-body">
            <div class="fw-semibold mb-2">Mensaje</div>
            <textarea id="autoMessage" rows="2" class="form-control rounded-3"
              placeholder="Favor de escribir un mensaje..."></textarea>
            <div class="form-text">Se enviará al finalizar la encuesta.</div>
          </div>
        </div>

        <!-- Audiencia -->
        <div class="card mb-3 rounded-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">Audiencia</div>
              <span class="badge bg-light text-dark">Alcance: <span id="reachCount">—</span></span>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="audience_mode" id="audAll" value="all" checked>
              <label class="form-check-label" for="audAll">Todos los usuarios</label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="audience_mode" id="audSeg" value="segmented">
              <label class="form-check-label" for="audSeg">Segmentar</label>
            </div>

            <!-- Segmentación -->
            <div id="segmentationBlock" class="mt-3 border rounded p-3 d-none">
              <!-- Usuario (chips + buscador) -->
              <label class="form-label">Usuario</label>
              <div class="input-group mb-2">
                <div id="selectedUsers" class="chips-wrap form-control" aria-live="polite">
                  <!-- aquí se mostrarán chips de usuarios -->
                </div>
              </div>
              <div class="input-group mb-3">
                <input type="text" id="userSearch" class="form-control" placeholder="Buscar usuarios…">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"></button>
                <ul class="dropdown-menu dropdown-menu-end" id="userSearchMenu" style="max-height:260px;overflow:auto">
                  <!-- aquí aparecerán resultados -->
                </ul>
              </div>

              <!-- Departamento -->
              <div class="mb-3">
                <label class="form-label">Departamento</label>
                <select multiple id="fDepartments" class="form-select">
                </select>
                <div class="form-text">Selecciona uno o varios.</div>
              </div>

              <!-- Posición -->
              <div class="mb-3">
                <label class="form-label">Posición</label>
                <select multiple id="fPositions" class="form-select">
                </select>
              </div>

              <!-- Ubicación -->
              <div class="mb-1">
                <label class="form-label">Ubicación</label>
                <select multiple id="fLocations" class="form-select">
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Respuestas -->
        <div class="card mb-4 rounded-3">
          <div class="card-body">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isAnonymous">
              <label class="form-check-label" for="isAnonymous">Esta encuesta es anónima</label>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="d-flex flex-wrap gap-2 justify-content-end">
          <button type="submit" class="btn btn-primary" id="btnPublish">Publicar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ===== TEMPLATE: SECCIÓN ===== -->
<template id="tpl-section">
  <div class="section-col" data-section-id="">
    <div class="section-card">
      <div class="section-head">
        <span class="sec-title" data-bind="sec-title">Sección</span>
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown" data-bs-display="static">⋮</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><button class="dropdown-item" data-action="sec.rename" data-id="">Renombrar</button></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" data-action="sec.delete" data-id="">Eliminar</button></li>
          </ul>
        </div>
      </div>

      <div class="q-list" data-bind="q-list"></div>

      <div class="px-3 pb-2">
        <a class="link-add" data-add-question data-section="">Nueva pregunta</a>
      </div>

      <div class="section-foot">
        <div class="d-flex align-items-center gap-2">
          <span data-bind="sec-after-label">Después de la sección</span>
          <div class="dropdown">
            <button class="btn btn-light btn-sm dropdown-toggle"
                    type="button"
                    data-section-jump
                    data-section=""
                    data-bs-toggle="dropdown">Ir a la siguiente sección</button>
            <ul class="dropdown-menu dropdown-menu-end" data-jump-menu data-section=""></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- ===== TEMPLATE: PREGUNTA ===== -->
<template id="tpl-question">
  <div class="q-card" data-question-id="" data-type="" data-required="">
    <div class="d-flex justify-content-between align-items-center">
      <div class="q-title" data-bind="q-title">Pregunta</div>
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown" data-bs-display="static">⋮</button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item text-danger" data-action="q.delete" data-id="">Eliminar</button></li>
        </ul>
      </div>
    </div>

    <!-- Preview opcional para 'single' -->
    <div class="form-check mt-1" data-preview="single">
      <input class="form-check-input" type="radio" disabled>
      <label class="form-check-label">Opción 1</label>
    </div>

    <div class="q-footer"></div>
  </div>
</template>


<!-- 3.3 UN SOLO MODAL en toda la página -->
<div class="modal fade" id="qEditor" tabindex="-1" data-bs-backdrop="true" data-bs-focus="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar pregunta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-lg-8">
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <input id="qeTitle" class="form-control" placeholder="Pregunta">
            </div>

            <div id="qeOptionsWrap" class="mb-3 d-none">
              <div class="d-flex align-items-center gap-2 mb-2">
                <span class="fw-semibold">Opciones</span>
              </div>
              <div id="qeOptionsList"></div>
              <button id="qeAddOption" type="button" class="btn btn-outline-primary btn-sm mt-2">Nueva opción</button>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="fw-semibold mb-2">Tipo de respuesta</div>
            <div class="list-group" id="qeTypeList">
              <button type="button" class="list-group-item list-group-item-action" data-type="text">Texto</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="decimal">Número decimal</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="integer">Número entero</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="single">Opciones (selección única)</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="multiple">Opciones (selección múltiple)</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="rating">Calificación</button>
              <button type="button" class="list-group-item list-group-item-action" data-type="none">Sin respuesta</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer flex-column flex-sm-row gap-2">
        <div class="me-auto d-flex align-items-center gap-4">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="qeRequired">
            <label class="form-check-label" for="qeRequired">Obligatoria</label>
          </div>
          <div class="form-check form-switch" title="(próximamente)">
            <input class="form-check-input" type="checkbox" id="qeBranch" disabled>
            <label class="form-check-label" for="qeBranch">Ir a la sección según la respuesta</label>
          </div>
        </div>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="qeSave">Guardar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="{% static 'js/survey.js' %}"></script>
{% endblock %}

{# templates/surveys/admin/survey_detail.html #}
{% extends "layouts/base.html" %}
{% load static %}
{% block page_title %}{{ survey.title }} — Detalle{% endblock %}

{% block content %}
<div class="container py-4">
  
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <div>
        <a class="text-decoration-none text-muted small mb-1 d-inline-block" href="{% url 'survey_dashboard_admin' %}">
            <i class="fa-solid fa-arrow-left me-1"></i> Volver al listado
        </a>
        <h2 class="mb-0 fw-bold">{{ survey.title }}</h2>
        <div class="text-muted small mt-1">
            <i class="fa-regular fa-calendar me-1"></i> {{ survey.created_at|date:"d/m/Y" }} 
            <span class="mx-2">•</span> 
            <i class="fa-regular fa-user me-1"></i> {{ survey.creator.get_full_name|default:survey.creator.username }}
        </div>
    </div>
    
    <div class="d-flex gap-3">
        <a class="btn btn-outline-danger" href="{% url 'survey_responses' survey.id %}?ver=faltantes">
            <i class="fa-solid fa-user-xmark me-2"></i> C. Faltantes
        </a>
        
        <a class="btn btn-outline-success" href="{% url 'survey_responses' survey.id %}?ver=recibidas">
            <i class="fa-solid fa-check-double me-2"></i> R. Recibidas 
        </a>

        <a class="btn btn-success text-white" href="{% url 'survey_export_xlsx' survey.id %}">
            <i class="fa-solid fa-file-excel me-2"></i> Exportar Excel
        </a>
    </div>
  </div>

  <div class="row g-3 mb-5">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 text-primary">
                <i class="fa-solid fa-users fa-2x"></i>
            </div>
            <div>
                <div class="text-muted small fw-bold text-uppercase">Respuestas</div>
                <div class="fs-2 fw-bold text-dark">{{ responses_count }}</div>
            </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
            <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3 text-info">
                <i class="fa-solid fa-bullseye fa-2x"></i>
            </div>
            <div>
                <div class="text-muted small fw-bold text-uppercase">Esperadas</div>
                <div class="fs-2 fw-bold text-dark">{{ expected }}</div>
            </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="text-muted small fw-bold text-uppercase">Avance Global</div>
                <span class="badge bg-success bg-opacity-10 text-success">{{ progress|floatformat:0 }}%</span>
            </div>
            <div class="progress" style="height: 10px; border-radius: 10px;">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: {{ progress|floatformat:0 }}%; border-radius: 10px;">
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <h4 class="mb-3 fw-bold text-secondary">Análisis por Pregunta</h4>

  {# ====== GRÁFICAS / BLOQUES POR PREGUNTA ====== #}
  <div class="row g-4">
  {% for q in question_stats %}
    <div class="col-12"> <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom py-3">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div>
                <span class="badge bg-secondary mb-1">P{{ forloop.counter }}</span>
                <h5 class="card-title mb-0 fw-bold">{{ q.title }}</h5>
                <small class="text-muted">Tipo: {{ q.type|title }}</small>
              </div>

              <div class="d-flex flex-column align-items-end gap-1">
                {% if q.extra.avg and q.type == "rating" %}
                  <span class="badge bg-warning text-dark border border-warning">
                    <i class="fa-solid fa-star me-1"></i> Promedio: {{ q.extra.avg }}
                  </span>
                {% endif %}
                {% if q.extra.accuracy_pct %}
                  <span class="badge bg-success-subtle text-success border border-success-subtle">
                    <i class="fa-solid fa-check me-1"></i> Acierto: {{ q.extra.accuracy_pct }}%
                  </span>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card-body">
             {# --- Gráfico --- #}
             {% if q.chart %}
                <div style="position: relative; height:250px; width:100%"> <canvas id="chart-q{{ q.qid }}"></canvas>
                </div>
             {% endif %}

             {# --- Tabla de Detalles (Value Counts) --- #}
             {% if q.extra.value_counts %}
                <div class="mt-3 pt-3 border-top">
                    <button class="btn btn-sm btn-link text-decoration-none px-0 js-toggle-answers"
                            type="button"
                            data-target="#answers-{{ q.qid }}">
                      <i class="fa-solid fa-chevron-down me-1"></i> <span>Ver desglose de respuestas</span>
                    </button>
                    
                    <div id="answers-{{ q.qid }}" class="collapse mt-2">
                      <div class="table-responsive rounded border">
                        <table class="table table-sm table-striped mb-0">
                          <thead class="bg-light">
                            <tr>
                              <th class="ps-3">Respuesta</th>
                              <th class="text-end pe-3">Frecuencia</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for value, times in q.extra.value_counts %}
                              <tr>
                                <td class="ps-3">{{ value }}</td>
                                <td class="text-end pe-3 fw-bold">{{ times }}</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                </div>
             {% endif %}
          </div>
        </div>
    </div>
  {% empty %}
    <div class="col-12">
        <div class="alert alert-light text-center border py-5">
            <i class="fa-regular fa-folder-open fa-3x text-muted mb-3"></i>
            <p class="mb-0 text-muted">Esta encuesta aún no tiene preguntas configuradas.</p>
        </div>
    </div>
  {% endfor %}
  </div>

</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  {# Bootstrap Bundle ya suele incluirse en layouts/base.html, pero si no, déjalo aquí #}
  {# <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> #}

  <script>
    const QUESTION_STATS = {{ question_stats_json|safe }};

    function genColors(n){
      const out = [];
      for (let i=0; i<n; i++){
        // Usamos una paleta más corporativa/suave en lugar de aleatoria pura
        const hue = Math.round((210 + (150/n)*i)) % 360; // Azules a Verdes
        out.push(`hsl(${hue}, 70%, 60%)`);
      }
      return out;
    }

    QUESTION_STATS.forEach(q => {
      if (!q.chart) return;
      const el = document.getElementById('chart-q'+q.qid);
      if (!el) return;

      // Configuración según tipo de gráfico
      // Si es 'rating' o 'integer' quizás convenga 'bar' vertical.
      // Si es 'single' (selección única), 'pie' o 'doughnut' se ven bien.
      let chartType = 'bar'; 
      if(q.type === 'single' || q.type === 'boolean') chartType = 'doughnut';

      const cfg = {
        type: chartType, 
        data: {
          labels: q.labels,
          datasets: [{
            label: 'Respuestas',
            data: q.data,
            backgroundColor: genColors(q.labels.length),
            borderWidth: 1,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // Importante para contenedores flexibles
          plugins: { 
            legend: { 
                display: chartType !== 'bar', // Mostrar leyenda solo si es circular
                position: 'right'
            }, 
            tooltip: { intersect: false } 
          },
          scales: chartType === 'bar' ? {
            y: { beginAtZero: true, ticks: { precision: 0 } },
            x: { grid: { display: false } }
          } : {} // Sin ejes para gráficos circulares
        }
      };
      new Chart(el, cfg);
    });
  </script>

  <script>
    // Lógica para el botón "Ver respuestas"
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.js-toggle-answers');
      if (!btn) return;
      const sel = btn.getAttribute('data-target');
      const el  = document.querySelector(sel);
      if (!el) return;

      // Usar la API de Bootstrap para colapsar
      const bsCollapse = new bootstrap.Collapse(el, { toggle: true });
    });

    // Cambiar texto e icono al abrir/cerrar
    document.querySelectorAll('.collapse').forEach(el => {
      el.addEventListener('show.bs.collapse', () => {
        const btn = document.querySelector(`.js-toggle-answers[data-target="#${el.id}"]`);
        if (btn) btn.innerHTML = '<i class="fa-solid fa-chevron-up me-1"></i> Ocultar desglose';
      });
      el.addEventListener('hide.bs.collapse', () => {
        const btn = document.querySelector(`.js-toggle-answers[data-target="#${el.id}"]`);
        if (btn) btn.innerHTML = '<i class="fa-solid fa-chevron-down me-1"></i> Ver desglose de respuestas';
      });
    });
  </script>
{% endblock %}
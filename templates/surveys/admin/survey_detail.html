{# templates/surveys/admin/survey_detail.html #}
{% extends "layouts/base.html" %}
{% load static %}
{% block page_title %}{{ survey.title }} — Detalle{% endblock %}

{% block content %}
<div class="container py-3">
  <a class="btn btn-light mb-3" href="{% url 'survey_dashboard_admin' %}">← Volver</a>

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="mb-0">{{ survey.title }}</h2>
    <a class="btn btn-primary" href="#">Descargar</a>
  </div>
  <p class="text-muted mb-3">
    Creada el {{ survey.created_at|date:"d/m/Y" }} ·
    por {{ survey.creator.get_full_name|default:survey.creator.username }}
  </p>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card"><div class="card-body">
        <div class="fw-semibold">Respuestas recibidas</div>
        <div class="display-6">{{ responses_count }}</div>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card"><div class="card-body">
        <div class="fw-semibold">Audiencia esperada</div>
        <div class="display-6">{{ expected }}</div>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card"><div class="card-body">
        <div class="fw-semibold mb-2">Avance</div>
        <div class="progress"><div class="progress-bar" style="width: {{ progress|floatformat:0 }}%"></div></div>
        <div class="mt-1 text-muted">{{ progress|floatformat:0 }}%</div>
      </div></div>
    </div>
  </div>

  {# ====== GRÁFICAS / BLOQUES POR PREGUNTA ====== #}
  {% for q in question_stats %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">{{ forloop.counter }}. {{ q.title }}</div>
            <div class="text-muted small">Tipo: {{ q.type }}</div>
          </div>

          <div class="d-flex gap-2">
            {% if q.extra.avg and q.type == "rating" %}
              <span class="badge bg-light text-dark">Promedio: {{ q.extra.avg }}</span>
            {% endif %}
            {% if q.extra.accuracy_pct %}
              <span class="badge bg-success-subtle text-success">Acierto: {{ q.extra.accuracy_pct }}%</span>
            {% endif %}
          </div>
        </div>

          {# --- gráfico si hay --- #}
          {% if q.chart %}
            <div class="mt-3">
              <canvas id="chart-q{{ q.qid }}" height="140"></canvas>
            </div>
          {% endif %}

          {# --- botón/ver tabla si hay value_counts --- #}
          {% if q.extra.value_counts %}
            <button class="btn btn-sm btn-outline-primary js-toggle-answers"
                    type="button"
                    data-target="#answers-{{ q.qid }}">
              Ver respuestas
            </button>
            <div id="answers-{{ q.qid }}" class="collapse mt-3">
              <h6 class="mb-2">Respuestas</h6>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th style="width:70%">Respuesta</th>
                      <th class="text-end">Veces</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for value, times in q.extra.value_counts %}
                      <tr>
                        <td>{{ value }}</td>
                        <td class="text-end">{{ times }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}
      </div>
    </div>
  {% empty %}
    <div class="text-muted">No hay preguntas en esta encuesta.</div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Datos serializados desde Django
    const QUESTION_STATS = {{ question_stats_json|safe }};

    // Paleta simple
    function genColors(n){
      const out = [];
      for (let i=0;i<n;i++){
        const h = Math.round((360/n)*i);
        out.push(`hsl(${h} 70% 55% / .85)`);
      }
      return out;
    }

    // Render
    QUESTION_STATS.forEach(q => {
      if (!q.chart) return;
      const el = document.getElementById('chart-q'+q.qid);
      if (!el) return;

      const cfg = {
        type: q.chart, // usamos 'bar' para todos los soportados
        data: {
          labels: q.labels,
          datasets: [{
            label: 'Respuestas',
            data: q.data,
            backgroundColor: genColors(q.labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { intersect: false } },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      };
      new Chart(el, cfg);
    });
  </script>
<script>
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.js-toggle-answers');
  if (!btn) return;
  const sel = btn.getAttribute('data-target');
  const el  = document.querySelector(sel);
  if (!el) return;

  const c = bootstrap.Collapse.getOrCreateInstance(el);
  c.toggle();
});

// Sincroniza el texto del botón con el estado real del collapse
document.querySelectorAll('.collapse').forEach(el => {
  el.addEventListener('shown.bs.collapse', () => {
    const btn = document.querySelector(`.js-toggle-answers[data-target="#${el.id}"]`);
    if (btn) btn.textContent = 'Ocultar respuestas';
  });
  el.addEventListener('hidden.bs.collapse', () => {
    const btn = document.querySelector(`.js-toggle-answers[data-target="#${el.id}"]`);
    if (btn) btn.textContent = 'Ver respuestas';
  });
});
</script>

{% endblock %}
